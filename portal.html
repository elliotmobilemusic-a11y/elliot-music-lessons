<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Portal â€“ Elliot's Mobile Music</title>
    <link rel="icon" href="/favicon.png" />

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tailwind Theme -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-dark-bg': '#1a1a2e',
                        'brand-accent-light': '#00d084',
                        'brand-accent-dark': '#00a36e',
                        'brand-text-light': '#e0e0e0',
                        'brand-text-mid': '#a0a0a0',
                        'brand-highlight': '#ffb703',
                        'card-bg': '#252538',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        heading: ['Montserrat', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <!-- Google Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Montserrat:wght@700;800;900&display=swap');

        body {
            background: #1a1a2e;
            background-image: radial-gradient(circle at 100% 100%, #252538 0%, #1a1a2e 70%);
            color: #e0e0e0;
            font-family: 'Inter', sans-serif;
        }

        .card {
            background: #252538;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(0,208,132,0.3);
            box-shadow: 0 0 25px rgba(0,208,132,0.07);
        }
    </style>

    <!-- Lucide Icons -->
    <script type="module">
        import { createIcons, LogOut, FileText, BookOpen, Bell } from "https://cdn.jsdelivr.net/npm/lucide@latest/dist/esm/lucide.js";
        createIcons({ icons: { LogOut, FileText, BookOpen, Bell } });
    </script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="min-h-screen">

    <!-- HEADER -->
    <header class="p-6 flex justify-between items-center">
        <h1 class="font-heading text-3xl font-extrabold text-brand-highlight">
            Student Portal
        </h1>
        <button id="logout-btn"
            class="px-4 py-2 flex items-center gap-2 bg-brand-accent-light text-brand-dark-bg rounded-lg font-bold hover:bg-brand-accent-dark transition">
            <i data-lucide="log-out" class="w-5 h-5"></i> Logout
        </button>
    </header>

    <main class="max-w-5xl mx-auto p-6 space-y-8">

        <!-- Welcome Block -->
        <div class="card text-center">
            <h2 id="welcome-name" class="text-2xl font-bold text-brand-accent-light">Welcome!</h2>
            <p class="text-brand-text-mid mt-1">Here you can find your newsletters, files, and lesson info.</p>
        </div>

        <!-- NEWSLETTERS FEED -->
        <section class="card">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                <i data-lucide="bell" class="w-5 h-5 text-brand-highlight"></i>
                Latest Newsletters
            </h3>
            <div id="newsletter-list" class="space-y-4 text-brand-text-mid"></div>
        </section>

        <!-- FILES -->
        <section class="card">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                <i data-lucide="file-text" class="w-5 h-5 text-brand-highlight"></i>
                Your Files
            </h3>
            <div id="files-list" class="space-y-2"></div>
        </section>

        <!-- NEXT LESSON (Placeholder for now) -->
        <section class="card">
            <h3 class="text-xl font-bold mb-2 flex items-center gap-2">
                <i data-lucide="book-open" class="w-5 h-5 text-brand-highlight"></i>
                Your Next Lesson
            </h3>
            <p class="text-brand-text-mid">Coming soon (we will integrate your travel logic + schedule)</p>
        </section>

    </main>

    <script>
        // Supabase client
        const supabase = supabase.createClient(
            "https://gorrhpliwhpznmdqhzjo.supabase.co",
            "YOUR-ANON-KEY-HERE"
        );

        // Logout
        document.getElementById("logout-btn").onclick = async () => {
            await supabase.auth.signOut();
            window.location.href = "login.html";
        };

        // Load user + portal data
        async function loadPortal() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) return window.location.href = "login.html";

            document.getElementById("welcome-name").textContent =
                `Welcome, ${user.email}!`;

            loadNewsletters();
            loadFiles(user.id);
        }

        async function loadNewsletters() {
            const { data, error } = await supabase
                .from("newsletters")
                .select("*")
                .eq("published", true)
                .order("created_at", { ascending: false });

            const container = document.getElementById("newsletter-list");

            if (!data || data.length === 0) {
                container.innerHTML = `<p class="text-brand-text-mid">No newsletters yet.</p>`;
                return;
            }

            container.innerHTML = data
                .map(n => `
                    <div class="p-4 border border-brand-accent-light/20 rounded-lg">
                        <h4 class="text-brand-accent-light font-bold text-lg">${n.title}</h4>
                        <div class="mt-2">${n.content_html}</div>
                        <p class="text-xs text-brand-text-mid mt-2">${new Date(n.created_at).toLocaleString()}</p>
                    </div>
                `)
                .join("");
        }

        async function loadFiles(userId) {
            const { data: files } = await supabase.storage
                .from("student_files")
                .list(`${userId}/`);

            const container = document.getElementById("files-list");

            if (!files || files.length === 0) {
                container.innerHTML = `<p class="text-brand-text-mid">No files uploaded yet.</p>`;
                return;
            }

            container.innerHTML = files
                .map(f => {
                    const url = supabase.storage
                        .from("student_files")
                        .getPublicUrl(`${userId}/${f.name}`).data.publicUrl;

                    return `
                        <div class="flex justify-between items-center p-3 bg-brand-dark-bg/40 rounded-lg">
                            <span>${f.name}</span>
                            <a href="${url}" target="_blank"
                                class="text-brand-accent-light underline">
                                Download
                            </a>
                        </div>
                    `;
                })
                .join("");
        }

        loadPortal();
    </script>
</body>
</html>
