<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elliot Wardill - Mobile Music Lessons</title>
    <link rel="icon" href="/favicon.png" type="image/png">
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Custom Tailwind Config for Theme -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-dark-bg': '#1a1a2e', // Deep dark blue
                        'brand-accent-light': '#00d084', // Vibrant green/aqua
                        'brand-accent-dark': '#00a36e', // Darker green/aqua
                        'brand-text-light': '#e0e0e0', // Light grey for text
                        'brand-text-mid': '#a0e0e0', // Mid grey for secondary text
                        'brand-highlight': '#ffb703', // Vibrant golden yellow
                        'card-bg': '#252538', // Slightly lighter dark background for containers
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        heading: ['Montserrat', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Montserrat:wght@700;800;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e;
            color: #e0e0e0;
            /* Subtle radial gradient for depth */
            background-image: radial-gradient(circle at 100% 100%, #252538 0%, #1a1a2e 70%);
        }
        .main-hero-shadow {
            text-shadow: 0 0 10px rgba(0, 208, 132, 0.5);
        }
        .card-glow {
            box-shadow: 0 5px 15px rgba(0, 208, 132, 0.1), 0 2px 5px rgba(0, 208, 132, 0.05);
        }
        /* Style the chat input and button for better integration */
        #chat-input:focus {
            border-color: #00d084;
            box-shadow: 0 0 0 3px rgba(0, 208, 132, 0.5);
        }

        /* --- Advanced Typing Indicator Animation --- */
        @keyframes dot-pulse {
            0%, 100% { opacity: 0.2; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.4); }
        }
        .dot-1 { animation: dot-pulse 1.5s infinite 0s; }
        .dot-2 { animation: dot-pulse 1.5s infinite 0.2s; }
        .dot-3 { animation: dot-pulse 1.5s infinite 0.4s; }
        /* ------------------------------------------- */
        /* General input group styling */
        .input-group {
            background-color: #252538;
            border-radius: 0.5rem;
        }
        /* Sticky CTA specific styling */
        #sticky-cta {
            position: fixed;
            bottom: 1.5rem; /* Large enough for mobile tap targets */
            right: 1.5rem;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateY(20px);
        }
        #sticky-cta.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Contact Box specific styling */
        .contact-box a:hover {
            text-decoration: underline;
        }

        /* Toggle switch styling */
        .toggle-switch {
            @apply relative inline-block w-12 h-6 rounded-full cursor-pointer transition-colors duration-200;
        }
        .toggle-switch input {
            @apply opacity-0 w-0 h-0;
        }
        .slider {
            @apply absolute top-0 left-0 right-0 bottom-0 bg-gray-600 rounded-full transition-colors duration-200;
        }
        .slider:before {
            content: "";
            @apply absolute h-4 w-4 left-1 bottom-1 bg-white rounded-full transition-transform duration-200;
        }
        input:checked + .slider {
            @apply bg-brand-accent-light;
        }
        input:checked + .slider:before {
            transform: translateX(24px);
        }
    </style>
    <!-- Load Lucide Icons -->
    <script type="module">
        import { createIcons, Zap, BookOpen, Clock, Mail, Phone, MapPin, Loader2, Send, History, Star, Calculator, MessageSquare, Rocket } from 'https://cdn.jsdelivr.net/npm/lucide@latest/dist/esm/lucide.js';
        createIcons({ icons: { Zap, BookOpen, Clock, Mail, Phone, MapPin, Loader2, Send, History, Star, Calculator, MessageSquare, Rocket } });
    </script>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Navigation Bar -->
    <nav class="bg-brand-dark-bg text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo/Brand Name -->
                <div class="flex-shrink-0">
                    <a href="index.html" class="text-xl font-extrabold tracking-wider text-brand-highlight hover:text-white transition duration-200">
                        ELLIOT'S MOBILE MUSIC
                    </a>
                </div>

                <!-- Desktop Navigation Links -->
                <div class="hidden sm:ml-6 sm:flex sm:space-x-4">
                    <a href="index.html" class="border-b-2 border-brand-accent-light text-brand-accent-light px-3 py-2 text-sm font-medium transition duration-200">HOME</a>
                    <a href="pricing.html" class="border-b-2 border-transparent hover:border-brand-accent-light hover:text-white text-brand-text-light px-3 py-2 text-sm font-medium transition duration-200">PRICING & FEES</a>
                    <a href="availability.html" class="border-b-2 border-transparent hover:border-brand-accent-light hover:text-white text-brand-text-light px-3 py-2 text-sm font-medium transition duration-200">AVAILABILITY</a>
                    <a href="contact.html" class="border-b-2 border-transparent hover:border-brand-accent-light hover:text-white text-brand-text-light px-3 py-2 text-sm font-medium transition duration-200">CONTACT</a>
                </div>

                <!-- Mobile Menu Button -->
                <div class="sm:hidden">
                    <button id="mobile-menu-button" class="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-white hover:bg-brand-accent-dark focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white" aria-expanded="false">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile Menu (Hidden by default) -->
        <div class="sm:hidden hidden" id="mobile-menu">
            <div class="pt-2 pb-3 space-y-1 px-2">
                <a href="index.html" class="bg-brand-accent-dark text-white block rounded-md px-3 py-2 text-base font-medium">HOME</a>
                <a href="pricing.html" class="text-brand-text-light hover:bg-brand-accent-dark block rounded-md px-3 py-2 text-base font-medium">PRICING & FEES</a>
                <a href="availability.html" class="text-brand-text-light hover:bg-brand-accent-dark block rounded-md px-3 py-2 text-base font-medium">AVAILABILITY</a>
                <a href="contact.html" class="text-brand-text-light hover:bg-brand-accent-dark block rounded-md px-3 py-2 text-base font-medium">CONTACT</a>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="max-w-6xl mx-auto px-4 py-8 sm:py-12 flex-grow">

        <!-- Hero Section -->
        <header id="hero-section" class="text-center mb-10">
            <h1 class="font-heading text-5xl sm:text-6xl md:text-7xl font-extrabold tracking-tighter leading-tight mb-3 main-hero-shadow">
                <span class="text-brand-accent-light">Elliot Wardill</span>
                <br class="hidden sm:inline"> Mobile Music Lessons
            </h1>
            <p class="text-lg sm:text-xl text-brand-text-mid max-w-3xl mx-auto">
                Piano and Singing Lessons brought right to your home in **Pudsey**, **Leeds**, and surrounding areas.
            </p>
            <div class="mt-6 flex justify-center space-x-4">
                <a href="availability.html" class="inline-flex items-center justify-center px-5 py-2.5 border border-transparent text-base font-medium rounded-lg text-brand-dark-bg bg-brand-accent-light hover:bg-brand-accent-dark transition duration-300 transform hover:scale-[1.03] shadow-lg shadow-brand-accent-light/30">
                    <i data-lucide="clock" class="w-5 h-5 mr-2"></i> Check Availability
                </a>
                <a href="contact.html" class="inline-flex items-center justify-center px-5 py-2.5 border border-brand-highlight text-base font-medium rounded-lg text-brand-highlight hover:bg-brand-highlight/10 transition duration-300 transform hover:scale-[1.03]">
                    <i data-lucide="mail" class="w-5 h-5 mr-2"></i> Book a Lesson
                </a>
            </div>
        </header>

        <!-- Instructor Bio / Visual Rapport Section -->
        <section class="mb-12">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-center bg-card-bg p-6 rounded-xl border border-brand-accent-dark/50">
                <div class="md:col-span-2">
                    <h2 class="font-heading text-3xl font-bold text-brand-accent-light mb-3">Meet Your Tutor</h2>
                    <p class="text-brand-text-mid mb-4">
                        Elliot is a professional musician and experienced educator who brings passion and expertise directly to your home. He believes music education should be fun, accessible, and tailored to the individual student's aspirations, whether they aim for examinations or simply want to play their favorite songs.
                    </p>
                    <!-- Prominent Contact Block -->
                    <div class="contact-box flex flex-col sm:flex-row gap-4 text-sm mt-4 p-4 rounded-lg bg-brand-dark-bg/50 border border-brand-highlight/30">
                        <span class="flex items-center text-brand-text-light font-semibold">
                            <i data-lucide="phone" class="w-4 h-4 mr-2 text-brand-highlight"></i>
                            Call: <a href="tel:07368975144" class="ml-1 hover:text-white">07368 975144</a>
                        </span>
                        <span class="flex items-center text-brand-text-light font-semibold">
                            <i data-lucide="mail" class="w-4 h-4 mr-2 text-brand-highlight"></i>
                            Email: <a href="mailto:elliotmobilemusic@gmail.com" class="ml-1 hover:text-white">elliotmobilemusic@gmail.com</a>
                        </span>
                    </div>
                </div>
                <div class="md:col-span-1 flex justify-center">
                    <!-- Placeholder for Instructor Photo -->
                    <img src="https://placehold.co/300x300/1a1a2e/00d084?text=Elliot+Wardill" alt="Elliot Wardill, Music Tutor" class="rounded-xl shadow-2xl w-48 h-48 md:w-full md:h-auto object-cover border-4 border-brand-accent-light/50" onerror="this.onerror=null; this.src='https://placehold.co/300x300/1a1a2e/00d084?text=Elliot+Wardill'">
                </div>
            </div>
        </section>

        <!-- Key Features Section -->
        <section class="mb-12">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

                <!-- Feature 1: Expertise -->
                <div class="bg-card-bg p-5 rounded-xl card-glow border-t-4 border-brand-accent-light hover:border-brand-highlight transition duration-300">
                    <i data-lucide="book-open" class="w-7 h-7 text-brand-accent-light mb-2"></i>
                    <h3 class="text-lg font-semibold text-brand-text-light mb-1">Tailored Learning</h3>
                    <p class="text-brand-text-mid text-xs">Lessons are customized to your age, goals, and interests, focusing on musicality, rhythm, and performance confidence.</p>
                </div>

                <!-- Feature 2: Convenience -->
                <div class="bg-card-bg p-5 rounded-xl card-glow border-t-4 border-brand-accent-light hover:border-brand-highlight transition duration-300">
                    <i data-lucide="map-pin" class="w-7 h-7 text-brand-highlight mb-2"></i>
                    <h3 class="text-lg font-semibold text-brand-text-light mb-1">We Come To You</h3>
                    <p class="text-brand-text-mid text-xs">Enjoy lessons in the comfort of your own home. All necessary equipment, including a keyboard, is provided.</p>
                </div>

                <!-- Feature 3: Safety/Vetting -->
                <div class="bg-card-bg p-5 rounded-xl card-glow border-t-4 border-brand-highlight hover:border-brand-accent-light transition duration-300">
                    <i data-lucide="zap" class="w-7 h-7 text-brand-highlight mb-2"></i>
                    <h3 class="text-lg font-semibold text-brand-text-light mb-1">Fully Vetted</h3>
                    <p class="text-brand-text-mid text-xs">For peace of mind, Elliot holds a valid **DBS check** for working with children, and is fully insured.</p>
                </div>
            </div>
        </section>

        <!-- LLM Q&A Chat Section -->
        <section class="bg-card-bg p-5 sm:p-6 rounded-xl card-glow border border-brand-accent-dark/50">
            <!-- Title and Mode Selector -->
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-5 border-b border-brand-accent-dark pb-3">
                <div class="flex items-center mb-3 sm:mb-0">
                    <h2 class="font-heading text-2xl font-bold text-brand-highlight flex items-center">
                        <i id="mode-icon" data-lucide="message-square" class="w-6 h-6 mr-2 text-brand-accent-light"></i>
                        <span id="mode-title">Lesson Assistant Q&A</span>
                    </h2>
                </div>

                <!-- Mode Toggle Switch -->
                <div class="flex items-center space-x-3 text-sm">
                    <i data-lucide="message-square" class="w-4 h-4 text-brand-text-mid"></i>
                    <label class="toggle-switch">
                        <input type="checkbox" id="mode-toggle">
                        <span class="slider"></span>
                    </label>
                    <i data-lucide="calculator" class="w-4 h-4 text-brand-accent-light"></i>
                    <span class="text-brand-text-mid">Calculator Mode</span>
                    <button id="clear-history-button" class="text-brand-text-mid hover:text-brand-highlight transition duration-200 text-sm flex items-center p-2 rounded-lg hover:bg-brand-accent-light/10 ml-4">
                        <i data-lucide="history" class="w-4 h-4 mr-1"></i> Clear
                    </button>
                </div>
            </div>

            <!-- Chat Box with A11Y improvement: aria-live region -->
            <div id="chat-box" class="h-[20rem] md:h-96 overflow-y-auto p-4 mb-3 rounded-lg bg-brand-dark-bg border border-brand-accent-dark/50 space-y-3" role="log" aria-live="polite" aria-atomic="false">
                <!-- Initial Bot Message -->
                <div class="flex justify-start initial-message">
                    <div class="max-w-[75%] bg-brand-accent-light/20 text-brand-text-light p-3 rounded-xl rounded-tl-none text-sm shadow">
                        Hello! I am the Lesson Assistant, ready to answer your questions about lesson policies, fees, availability, and photo consent.
                    </div>
                </div>
                <!-- Chat messages will be appended here -->

                <!-- Animated Loading Indicator -->
                <div id="loading-indicator" class="hidden flex justify-start">
                    <div class="max-w-[75%] bg-brand-highlight/20 text-brand-highlight p-3 rounded-xl rounded-tl-none text-sm shadow flex items-center space-x-1">
                        <span class="text-sm">Typing</span>
                        <span class="w-2 h-2 bg-brand-highlight rounded-full dot-1"></span>
                        <span class="w-2 h-2 bg-brand-highlight rounded-full dot-2"></span>
                        <span class="w-2 h-2 bg-brand-highlight rounded-full dot-3"></span>
                    </div>
                </div>
            </div>
            <!-- Text Query Input & Send Button -->
            <form id="chat-form" class="flex gap-2">
                <input type="text" id="chat-input" placeholder="Ask a question about fees, availability, or policies..." class="flex-grow p-3 rounded-lg bg-brand-dark-bg border border-brand-text-mid/50 focus:outline-none text-brand-text-light transition duration-200 text-sm">
                <button type="submit" id="send-button" class="bg-brand-highlight text-brand-dark-bg p-3 rounded-lg font-semibold hover:bg-brand-highlight/80 transition duration-200 flex items-center justify-center w-10 h-10" aria-label="Send message">
                    <i data-lucide="send" class="w-5 h-5"></i>
                </button>
            </form>
            <div id="error-container" class="mt-2">
                <p id="error-message" class="text-xs text-red-400 hidden" role="alert"></p>
                <p id="mode-tip" class="text-xs text-brand-text-mid mt-1">Tip: Switch to Calculator Mode to get cost estimates, like "How much is a 60-minute lesson with a 7-mile travel fee?"</p>
            </div>
        </section>
    </main>

    <!-- Sticky CTA Button (Hidden until scrolled) -->
    <a href="contact.html" id="sticky-cta" class="inline-flex items-center justify-center px-4 py-2.5 text-base font-medium rounded-full text-brand-dark-bg bg-brand-accent-light hover:bg-brand-accent-dark transition duration-300 shadow-xl shadow-brand-accent-light/50">
        <i data-lucide="mail" class="w-5 h-5 mr-1"></i> Book Now
    </a>

    <!-- Footer -->
    <footer class="bg-gray-900 text-brand-text-mid py-6 mt-8 flex-shrink-0">
        <div class="max-w-6xl mx-auto px-4 text-center text-sm">
            <p>&copy; 2024 Elliot Wardill Mobile Music Lessons. All rights reserved.</p>
            <p class="mt-2 text-gray-500">DBS Checked & Insured. Policy documents available upon request.</p>
        </div>
    </footer>
    <!-- JavaScript for Mobile Menu, Advanced API Interaction, and Sticky CTA -->
    <script>
        // IIFE for scope management and advanced logic
        (function() {
            // Mobile Menu Toggle
            document.getElementById('mobile-menu-button').addEventListener('click', function() {
                var menu = document.getElementById('mobile-menu');
                menu.classList.toggle('hidden');
            });

            // --- Sticky CTA Logic ---
            const stickyCta = document.getElementById('sticky-cta');
            const heroSection = document.getElementById('hero-section');

            if (stickyCta && heroSection) {
                const observer = new IntersectionObserver(
                    ([entry]) => {
                        // If the top of the hero section is intersecting (i.e., we are near the top)
                        if (entry.isIntersecting) {
                            stickyCta.classList.remove('show');
                        } else {
                            // If the top of the hero section is scrolled out of view
                            stickyCta.classList.add('show');
                        }
                    },
                    {
                        // Observe the bottom edge of the viewport
                        rootMargin: "0px 0px -100% 0px",
                        threshold: 0.1 // Trigger when 10% of the hero is scrolled out
                    }
                );
                observer.observe(heroSection);
            }

            // --- LLM Q&A Chat/Calculator Logic ---
            const CHAT_HISTORY_KEY = 'elliot_music_chat_history';
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');
            const chatBox = document.getElementById('chat-box');
            const loadingIndicator = document.getElementById('loading-indicator');
            const errorMessage = document.getElementById('error-message');
            const modeTip = document.getElementById('mode-tip');
            const sendButton = document.getElementById('send-button');
            const clearHistoryButton = document.getElementById('clear-history-button');
            const modeToggle = document.getElementById('mode-toggle');
            const modeTitle = document.getElementById('mode-title');
            const modeIcon = document.getElementById('mode-icon');

            // Global state for history
            let chatHistory = [];
            let currentMode = 'qa'; // 'qa' or 'calculator'

            const apiKey = ""
            const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";

            // --- Q&A SYSTEM INSTRUCTION (Unchanged for reliability) ---
            const qaSystemPrompt = `You are a helpful, friendly, and highly knowledgeable Q&A assistant for Elliot Wardill's Mobile Music Lessons. Your primary role is to act as an advanced Q&A system, answering questions concisely and clearly using the provided Context.
            **Context (Policy & Logistics):**
            --- General Information & Safety ---
            - **Instructor:** Elliot Wardill, a musician and educator based in Pudsey who currently works within the education sector.
            - **Services:** Piano and Singing Lessons.
            - **Delivery:** Lessons are mobile (at the student's home). Elliot brings all the necessary equipment (including a keyboard) so the student does not need to travel or provide their own instrument.
            - **Safety Vetting:** Elliot holds a valid **DBS check** for working with children. Parents/guardians are welcome to sit in on lessons.
            - **Safeguarding (Stanningley Primary School):** Any information or incidents disclosed by a child enrolled at Stanningley Primary School will be reported directly to the school authorities in line with safeguarding procedures.
            - **Policy Date:** 21/10/2025.
            --- Fees & Payment ---
            - **Introductory Offer:** The first lesson is offered at an introductory price of **£10**.
            - **Standard Lesson Fees:** 30 minutes: **£15**; 60 minutes: **£30**; 90 minutes: **£50**.
            - **Payment Methods:** Payment can be made in **cash** at the lesson or via **bank transfer** in advance.
            --- Location & Travel Fees (added to lesson cost for locations outside Pudsey) ---
            - Up to 5 Miles: **£5**
            - 5 to 10 Miles: **£10**
            - 10 to 15 Miles: **£20–£30** (Exact quote provided upon booking).
            --- Cancellations and Rescheduling Policy ---
            - **Notice Required:** Please give at least **24 hours’ notice** to cancel or reschedule a lesson.
            - **Late Cancellation Fee:** Cancellations with less than 24 hours’ notice **may be charged 50%** of the lesson fee.
            - **Instructor Cancellation:** If Elliot cancels (which is rare), he will **reschedule the lesson at no extra cost** to the student.
            --- Availability ---
            - **Available Times:** Tuesday, Wednesday, Thursday: **6pm – 9pm**.
            - **Weekend:** Saturday & Sunday are **available upon request**.
            - **Unavailable:** Monday & Friday have **no available slots**.
            --- Photo and Video Consent Policy ---
            - **Usage:** Social Media (first name only) and Website/Portfolio.
            - **Privacy Measures:** Surname, contact details, or specific location will **never** be published.
            - **Withdrawal of Consent:** Consent can be withdrawn at any time by written notice (email). Media already published may remain online.
            ***
            Keep responses brief and directly answer the user's query using the details above.`;

            // --- CALCULATOR SYSTEM INSTRUCTION (Unchanged for LLM fallback) ---
            const calculatorSystemPrompt = `You are an AI Cost Calculator for Elliot Wardill's Mobile Music Lessons. Your only task is to analyze the user's request and calculate a total cost based ONLY on the provided policy data. Respond ONLY with a JSON object that strictly adheres to the provided JSON Schema. Do NOT include any introductory or explanatory text.

            **Lesson Fees:** 30 min: 15, 60 min: 30, 90 min: 50.
            **Travel Fees (in miles from Pudsey):** Up to 5 Miles: 5. 5 to 10 Miles: 10. 10 to 15 Miles: 20 (Use 20 for estimates).
            **First Lesson:** 10 (Use this only if the user explicitly asks for the FIRST lesson).
            **Frequency:** Assume 4 weeks per month for monthly calculations unless specified otherwise (e.g., 'weekly' means 4 per month).

            If the user request is too vague to calculate, set 'success' to false and provide a helpful message in 'errorDetails'.`;

            // --- CALCULATOR JSON SCHEMA (Unchanged for LLM fallback) ---
            const calculatorSchema = {
                type: "OBJECT",
                properties: {
                    success: { type: "BOOLEAN", description: "True if a calculation was possible, false otherwise." },
                    errorDetails: { type: "STRING", description: "If success is false, explain what information is missing (e.g., 'Lesson duration is missing.')." },
                    lessonDurationMinutes: { type: "NUMBER", description: "The duration of one lesson in minutes (30, 60, or 90)." },
                    lessonCost: { type: "NUMBER", description: "The single lesson cost in GBP, including any first lesson discount." },
                    travelFee: { type: "NUMBER", description: "The calculated travel fee in GBP based on distance (5, 10, or 20)." },
                    lessonsPerMonth: { type: "NUMBER", description: "The estimated number of lessons per month (e.g., 4 for weekly, 2 for bi-weekly)." },
                    totalMonthlyCost: { type: "NUMBER", description: "The final total cost per month in GBP." },
                    calculationBreakdown: { type: "STRING", description: "A simple, single-sentence explanation of the calculation (e.g., '£30 lesson + £5 travel) x 4 weeks = £140')." },
                    source: { type: "STRING", description: "This will always be 'ai-fallback'." } // Added source for clarity
                },
                required: ["success", "errorDetails", "lessonDurationMinutes", "lessonCost", "travelFee", "lessonsPerMonth", "totalMonthlyCost", "calculationBreakdown", "source"],
                propertyOrdering: ["success", "errorDetails", "lessonDurationMinutes", "lessonCost", "travelFee", "lessonsPerMonth", "totalMonthlyCost", "calculationBreakdown", "source"]
            };

            // Helper function to update mode display
            function updateModeUI() {
                if (currentMode === 'qa') {
                    modeTitle.textContent = 'Lesson Assistant Q&A';
                    modeInputPlaceholder = 'Ask a question about fees, availability, or policies...';
                    modeTip.textContent = 'Tip: Switch to Calculator Mode to get cost estimates, like "How much is a 60-minute lesson with a 7-mile travel fee?"';
                    modeIcon.setAttribute('data-lucide', 'message-square');
                    if (typeof createIcons === 'function') {
                        createIcons({ icons: { MessageSquare } }); // Re-render icon
                    }
                } else { // calculator
                    modeTitle.textContent = 'Lesson Calculator (Hybrid)';
                    modeInputPlaceholder = 'E.g., "I want a weekly 90-minute lesson with a 3-mile travel fee."';
                    modeTip.textContent = 'Tip: Provide lesson duration, frequency (e.g., weekly, monthly), and travel distance (miles) for best results. Simple queries are INSTANT!';
                    modeIcon.setAttribute('data-lucide', 'calculator');
                    if (typeof createIcons === 'function') {
                        createIcons({ icons: { Calculator } }); // Re-render icon
                    }
                }
                chatInput.placeholder = modeInputPlaceholder;
            }

            // --- ADVANCED CODE: Client-Side Calculation Pre-processor ---
            function calculateClientSide(query) {
                const q = query.toLowerCase();
                const result = { duration: 0, cost: 0, distance: 0, travelFee: 0, frequency: 0, lessonsPerMonth: 0, isFirstLesson: false };

                // 1. Duration & Cost
                if (/(90|90\s*min|hour and a half)/.test(q)) {
                    result.duration = 90; result.cost = 50;
                } else if (/(60|60\s*min|hour)/.test(q)) {
                    result.duration = 60; result.cost = 30;
                } else if (/(30|30\s*min|half hour)/.test(q)) {
                    result.duration = 30; result.cost = 15;
                } else {
                    return null; // Must have a duration to calculate
                }

                // Check for introductory offer
                if (/(first|introductory|trial)/.test(q)) {
                    result.isFirstLesson = true;
                    result.cost = 10;
                }

                // 2. Distance & Travel Fee (using fixed policy tiers)
                const distanceMatch = q.match(/(\d+)\s*(mile|mi)/);
                if (distanceMatch) {
                    result.distance = parseInt(distanceMatch[1], 10);
                    if (result.distance <= 5) {
                        result.travelFee = 5;
                    } else if (result.distance <= 10) {
                        result.travelFee = 10;
                    } else if (result.distance <= 15) {
                        result.travelFee = 20; // Use minimum fee for simplicity
                    } else {
                         // >15 miles is too complex for client-side as it is £20-£30
                         return null;
                    }
                } else {
                    // Default to 0 if not specified (assumed to be in Pudsey/local area)
                    result.travelFee = 0;
                }

                // 3. Frequency (Default to weekly if duration found but frequency is absent)
                if (/(bi-weekly|twice\s*a\s*month|every 2 weeks)/.test(q)) {
                    result.lessonsPerMonth = 2;
                } else if (/(once\s*a\s*month|monthly)/.test(q)) {
                    result.lessonsPerMonth = 1;
                } else {
                    // Default to weekly (4) for any other case where duration was found
                    result.lessonsPerMonth = 4;
                }
                
                // Final calculation
                result.totalMonthlyCost = (result.cost + result.travelFee) * result.lessonsPerMonth;
                
                // If it's the first lesson, we can't calculate a monthly cost in a sensible way, so let LLM handle it
                if (result.isFirstLesson && result.lessonsPerMonth > 1) {
                    return null;
                }

                // Construct final structured output (matching LLM schema for consistency)
                return {
                    success: true,
                    source: 'client-side',
                    lessonDurationMinutes: result.duration,
                    lessonCost: result.cost,
                    travelFee: result.travelFee,
                    lessonsPerMonth: result.lessonsPerMonth,
                    totalMonthlyCost: result.totalMonthlyCost,
                    calculationBreakdown: `(£${result.cost} lesson ${result.isFirstLesson ? '(First Lesson Discount)' : ''} + £${result.travelFee} travel) x ${result.lessonsPerMonth} weeks`
                };
            }
            // --- END ADVANCED CODE ---


            // Function to render the JSON calculation result
            function renderCalculation(data) {
                // Ensure number formatting is correct for display
                const lessonCost = data.lessonCost.toFixed(2);
                const travelFee = data.travelFee.toFixed(2);
                const totalMonthlyCost = data.totalMonthlyCost.toFixed(2);

                if (!data.success) {
                    return `<div class="p-4 bg-red-400/20 text-red-100 rounded-xl border border-red-500">
                        <p class="font-semibold mb-1">Calculation Error</p>
                        <p class="text-xs">I couldn't complete the calculation. **Reason:** ${data.errorDetails}</p>
                    </div>`;
                }
                
                const isLocal = data.source === 'client-side';
                const sourceBadge = isLocal 
                    ? `<span class="bg-brand-accent-light text-brand-dark-bg px-2 py-0.5 rounded-full text-xs font-bold flex items-center"><i data-lucide="rocket" class="w-3 h-3 mr-1"></i> INSTANT</span>`
                    : `<span class="bg-brand-highlight text-brand-dark-bg px-2 py-0.5 rounded-full text-xs font-bold flex items-center"><i data-lucide="star" class="w-3 h-3 mr-1"></i> AI PARSED</span>`;


                return `
                    <div class="p-5 bg-brand-dark-bg rounded-xl border-t-4 ${isLocal ? 'border-brand-accent-light' : 'border-brand-highlight'} text-brand-text-light shadow-xl">
                        <div class="flex justify-between items-center mb-3">
                             <h4 class="text-xl font-heading font-bold text-white">Cost Estimate</h4>
                             ${sourceBadge}
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between border-b border-gray-700/50 pb-1">
                                <span class="text-brand-text-mid">Lesson Duration:</span>
                                <span class="font-semibold">${data.lessonDurationMinutes} mins</span>
                            </div>
                            <div class="flex justify-between border-b border-gray-700/50 pb-1">
                                <span class="text-brand-text-mid">Lesson Cost (Single):</span>
                                <span class="font-semibold">£${lessonCost}</span>
                            </div>
                            <div class="flex justify-between border-b border-gray-700/50 pb-1">
                                <span class="text-brand-text-mid">Estimated Travel Fee (Single):</span>
                                <span class="font-semibold">£${travelFee}</span>
                            </div>
                            <div class="flex justify-between border-b border-gray-700/50 pb-1">
                                <span class="text-brand-text-mid">Lessons per Month:</span>
                                <span class="font-semibold">${data.lessonsPerMonth}</span>
                            </div>
                            <div class="flex justify-between pt-2 border-t border-brand-highlight/50">
                                <span class="text-lg font-bold text-brand-accent-light">TOTAL MONTHLY ESTIMATE:</span>
                                <span class="text-lg font-bold text-brand-accent-light">£${totalMonthlyCost}</span>
                            </div>
                        </div>
                        <p class="text-xs text-brand-text-mid mt-4 italic border-t border-gray-700 pt-2">
                            Breakdown: ${data.calculationBreakdown}
                        </p>
                    </div>
                `;
            }

            // Helper function to append message to chat box UI
            function appendMessageToUI(sender, parts, isHtml = false) {
                const messageContainer = document.createElement('div');
                messageContainer.classList.add('flex', sender === 'user' ? 'justify-end' : 'justify-start');

                const bubble = document.createElement('div');
                bubble.classList.add(
                    'max-w-[75%]', 'p-3', 'rounded-xl', 'text-sm', 'shadow', 'break-words', 'whitespace-pre-wrap'
                );

                if (sender === 'user') {
                    bubble.classList.add('bg-brand-highlight', 'text-brand-dark-bg', 'rounded-tr-none');
                } else {
                    bubble.classList.add('bg-brand-accent-light/20', 'text-brand-text-light', 'rounded-tl-none');
                }

                if (isHtml) {
                     bubble.innerHTML = parts[0].text; // Directly inject HTML content
                } else {
                    // Process parts (text only now)
                    parts.forEach(part => {
                        if (part.text) {
                            const textNode = document.createElement('p');
                            textNode.innerHTML = part.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                            bubble.appendChild(textNode);
                        }
                    });
                }


                messageContainer.appendChild(bubble);
                chatBox.insertBefore(messageContainer, loadingIndicator);
                chatBox.scrollTop = chatBox.scrollHeight;
                
                // Re-render new icons
                if (typeof createIcons === 'function') {
                    createIcons({ icons: { Rocket, Star } });
                }
            }
            // Function to save chat history to localStorage (only text for simplicity)
            function saveChatHistory() {
                // Strip out non-text parts before saving to avoid hitting localStorage size limits
                const textOnlyHistory = chatHistory.map(item => ({
                    role: item.role,
                    parts: item.parts.filter(part => part.text)
                })).filter(item => item.parts.length > 0);

                try {
                    localStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(textOnlyHistory));
                } catch (e) {
                    console.error("Could not save chat history to localStorage:", e);
                }
            }

            // Function to clear chat history from localStorage and UI
            function clearChatHistory() {
                localStorage.removeItem(CHAT_HISTORY_KEY);
                chatHistory = [];

                chatBox.innerHTML = `
                    <div class="flex justify-start initial-message">
                        <div class="max-w-[75%] bg-brand-accent-light/20 text-brand-text-light p-3 rounded-xl rounded-tl-none text-sm shadow">
                            Hello! I am the Lesson Assistant, ready to answer your questions about lesson policies, fees, availability, and photo consent.
                        </div>
                    </div>
                    <div id="loading-indicator" class="hidden flex justify-start">
                        <div class="max-w-[75%] bg-brand-highlight/20 text-brand-highlight p-3 rounded-xl rounded-tl-none text-sm shadow flex items-center space-x-1">
                            <span class="text-sm">Typing</span>
                            <span class="w-2 h-2 bg-brand-highlight rounded-full dot-1"></span>
                            <span class="w-2 h-2 bg-brand-highlight rounded-full dot-2"></span>
                            <span class="w-2 h-2 bg-brand-highlight rounded-full dot-3"></span>
                        </div>
                    </div>
                `;
                chatBox.scrollTop = chatBox.scrollHeight;
            }

            // Function to load and display chat history from localStorage
            function loadChatHistory() {
                try {
                    const savedHistory = localStorage.getItem(CHAT_HISTORY_KEY);
                    if (savedHistory) {
                        // Clear the initial message before loading history
                        const initialMessage = chatBox.querySelector('.initial-message');
                        if (initialMessage) {
                            initialMessage.remove();
                        }

                        const parsedHistory = JSON.parse(savedHistory);
                        chatHistory = parsedHistory; // Restore history array

                        // Display restored history in UI
                        parsedHistory.forEach(message => {
                            if (message.role === 'user') {
                                // User messages are always plain text
                                appendMessageToUI(message.role, message.parts);
                            } else if (message.role === 'model') {
                                // Check if it's a calculator output that needs HTML rendering
                                const text = message.parts[0].text;
                                if (text.startsWith('CALCULATION: ')) {
                                    const jsonString = text.substring('CALCULATION: '.length);
                                    try {
                                        const data = JSON.parse(jsonString);
                                        const htmlContent = renderCalculation(data);
                                        appendMessageToUI('bot', [{ text: htmlContent }], true);
                                    } catch (e) {
                                        // If parsing fails, treat it as regular text
                                        appendMessageToUI('bot', [{ text: 'Error displaying previous calculation.' }]);
                                    }
                                } else {
                                    // Regular text response
                                    appendMessageToUI('bot', message.parts);
                                }
                            }
                        });

                        const historyMessage = document.createElement('div');
                        historyMessage.classList.add('text-center', 'text-brand-text-mid', 'text-xs', 'py-1');
                        historyMessage.innerHTML = '<i data-lucide="history" class="w-3 h-3 inline-block mr-1 align-sub"></i> Conversation loaded from history.';
                        chatBox.insertBefore(historyMessage, loadingIndicator);

                        // Re-create icons for the new element
                        if (typeof createIcons === 'function') {
                            createIcons({ icons: { History, Rocket, Star } });
                        }
                    }
                } catch (e) {
                    console.error("Could not load chat history from localStorage, starting new session:", e);
                    localStorage.removeItem(CHAT_HISTORY_KEY);
                    chatHistory = []; // Reset just in case of partial failure
                }
            }

            // Fetch data from Gemini API with exponential backoff
            async function fetchWithBackoff(url, options, retries = 5) { // Retries set to 5
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(url, options);
                        if (!response.ok) {
                            const errorBody = await response.text();
                            console.error("API Non-OK Response Details:", errorBody);
                            throw new Error(`API request failed with status ${response.status}. Details logged.`);
                        }
                        return response;
                    } catch (error) {
                        if (i === retries - 1) {
                            throw error;
                        }
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }

            // Core Logic to handle the user's input
            async function handleQuery(query) {
                sendButton.disabled = true;
                loadingIndicator.classList.remove('hidden');
                errorMessage.classList.add('hidden');
                chatBox.scrollTop = chatBox.scrollHeight;

                const userParts = [{ text: query.trim() }];
                appendMessageToUI('user', userParts);
                const userMessageForRequest = { role: "user", parts: userParts };
                
                // --- HYBRID LOGIC START ---
                if (currentMode === 'calculator') {
                    const clientResult = calculateClientSide(query);
                    if (clientResult && clientResult.success) {
                        // Success: Render client-side result instantly (FASTEST PATH)
                        const htmlContent = renderCalculation(clientResult);
                        const modelMessage = { role: "model", parts: [{ text: `CALCULATION: ${JSON.stringify(clientResult)}` }] };
                        chatHistory.push(userMessageForRequest, modelMessage);
                        appendMessageToUI('bot', [{ text: htmlContent }], true);
                        saveChatHistory();
                        loadingIndicator.classList.add('hidden');
                        sendButton.disabled = false;
                        chatInput.value = '';
                        return; // EXIT - No API call needed
                    }
                    // Client-side failed/was too complex, fall through to AI
                }
                // --- HYBRID LOG END / AI FALLBACK START ---
                
                // Add user message to history for the API call (Q&A mode uses full history, Calc mode uses single query)
                chatHistory.push(userMessageForRequest);
                const MAX_HISTORY_MESSAGES = 6;
                const contentHistory = chatHistory.slice(Math.max(chatHistory.length - MAX_HISTORY_MESSAGES, 0));

                let payload = {
                    contents: contentHistory,
                    tools: currentMode === 'qa' ? [{ "google_search": {} }] : undefined,
                    systemInstruction: {
                        parts: [{ text: currentMode === 'qa' ? qaSystemPrompt : calculatorSystemPrompt }]
                    },
                };
                
                if (currentMode === 'calculator') {
                    // Use LLM for parsing complex calculation requests
                    payload.generationConfig = {
                        responseMimeType: "application/json",
                        responseSchema: calculatorSchema
                    };
                    // Only send the current query, as calculations don't need history
                    payload.contents = [userMessageForRequest];
                }

                const options = {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                };

                try {
                    const urlWithKey = `${API_URL}?key=${apiKey}`;
                    const response = await fetchWithBackoff(urlWithKey, options);
                    const result = await response.json();

                    if (result.error) {
                        console.error("Gemini API Error Response:", result.error);
                        throw new Error(`API returned error in body: ${result.error.message}`);
                    }

                    const botCandidate = result.candidates?.[0];
                    let text = botCandidate?.content?.parts?.[0]?.text;

                    if (text) {
                        if (currentMode === 'calculator') {
                            // Handle JSON response from AI
                            const data = JSON.parse(text);
                            data.source = 'ai-fallback'; // Ensure source is labeled
                            const htmlContent = renderCalculation(data);
                            // Store original JSON text in history, but render HTML to UI
                            const modelMessage = { role: "model", parts: [{ text: `CALCULATION: ${JSON.stringify(data)}` }] };
                            chatHistory[chatHistory.length - 1] = modelMessage; // Replace the history entry that was just added with the LLM response
                            appendMessageToUI('bot', [{ text: htmlContent }], true);
                        } else {
                            // Handle standard Q&A text response
                            const modelMessage = { role: "model", parts: [{ text: text }] };
                            chatHistory[chatHistory.length - 1] = modelMessage; // Replace the history entry that was just added with the LLM response
                            appendMessageToUI('bot', modelMessage.parts);
                        }
                        saveChatHistory();
                    } else {
                        // Handle empty or missing text response
                        const modelMessage = { role: "model", parts: [{ text: "I received an empty response. Please try rephrasing your question." }] };
                        chatHistory[chatHistory.length - 1] = modelMessage; // Replace the history entry
                        appendMessageToUI('bot', modelMessage.parts);
                    }

                } catch (error) {
                    console.error(`Gemini API Request Failed in ${currentMode.toUpperCase()} mode:`, error);

                    let userVisibleError = "The assistant service failed due to a communication error. Please try again.";
                    if (error.message.includes('error in body')) {
                         userVisibleError = "The AI model returned an error. Try asking a simpler question.";
                    } else if (error instanceof SyntaxError) {
                         userVisibleError = "The model returned unparseable data. Try rephrasing your calculation request.";
                    }

                    errorMessage.textContent = userVisibleError;
                    errorMessage.classList.remove('hidden');

                    // Remove the failed user message from history
                    if (chatHistory.length > 0 && chatHistory[chatHistory.length - 1].role === 'user') {
                         chatHistory.pop();
                    }
                    // Informative failure message in the chat bubble
                    appendMessageToUI('bot', [{ text: "I apologize, but I can't process this right now. The AI service is temporarily unavailable. Please try your question again in a moment." }]);

                } finally {
                    loadingIndicator.classList.add('hidden');
                    sendButton.disabled = false;
                    chatInput.value = '';
                }
            }

            // --- Event Listeners ---
            chatForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const query = chatInput.value.trim();
                if (query) {
                    // Remove initial message if it's still present
                    const initialMessage = chatBox.querySelector('.initial-message');
                    if (initialMessage) {
                        initialMessage.remove();
                    }
                    handleQuery(query);
                }
            });

            clearHistoryButton.addEventListener('click', clearChatHistory);

            modeToggle.addEventListener('change', function() {
                currentMode = this.checked ? 'calculator' : 'qa';
                updateModeUI();
            });

            // --- Initialization ---
            updateModeUI();
            loadChatHistory();
        })();
    </script>
</body>
</html>
