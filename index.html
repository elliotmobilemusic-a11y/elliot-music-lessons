<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elliot Wardill - Mobile Music Lessons</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom Tailwind Config for Theme -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-dark-bg': '#1a1a2e', // Deep dark blue
                        'brand-accent-light': '#00d084', // Vibrant green/aqua
                        'brand-accent-dark': '#00a36e', // Darker green/aqua
                        'brand-text-light': '#e0e0e0', // Light grey for text
                        'brand-text-mid': '#a0a0a0', // Mid grey for secondary text
                        'brand-highlight': '#ffb703', // Vibrant golden yellow
                        'card-bg': '#252538', // Slightly lighter dark background for containers
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        heading: ['Montserrat', 'sans-serif'], 
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Montserrat:wght=700;800;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e; 
            color: #e0e0e0; 
            /* Subtle radial gradient for depth */
            background-image: radial-gradient(circle at 100% 100%, #252538 0%, #1a1a2e 70%);
        }
        .main-hero-shadow {
            text-shadow: 0 0 10px rgba(0, 208, 132, 0.5);
        }
        .card-glow {
             box-shadow: 0 5px 15px rgba(0, 208, 132, 0.1), 0 2px 5px rgba(0, 208, 132, 0.05);
        }
        /* Style the chat input and button for better integration */
        #chat-input:focus {
            border-color: #00d084;
            box-shadow: 0 0 0 3px rgba(0, 208, 132, 0.5);
        }
    </style>
    <!-- Load Lucide Icons -->
    <script type="module">
        import { createIcons, Zap, BookOpen, Clock, Mail, Phone, MapPin, Loader2, Send, History } from 'https://cdn.jsdelivr.net/npm/lucide@latest/dist/esm/lucide.js';
        createIcons({ icons: { Zap, BookOpen, Clock, Mail, Phone, MapPin, Loader2, Send, History } });
    </script>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Navigation Bar -->
    <nav class="bg-brand-dark-bg text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo/Brand Name -->
                <div class="flex-shrink-0">
                    <a href="index.html" class="text-xl font-extrabold tracking-wider text-brand-highlight hover:text-white transition duration-200">
                        ELLIOT'S MOBILE MUSIC
                    </a>
                </div>

                <!-- Desktop Navigation Links -->
                <div class="hidden sm:ml-6 sm:flex sm:space-x-4">
                    <a href="index.html" class="border-b-2 border-brand-accent-light text-brand-accent-light px-3 py-2 text-sm font-medium transition duration-200">HOME</a>
                    <a href="pricing.html" class="border-b-2 border-transparent hover:border-brand-accent-light hover:text-white text-brand-text-light px-3 py-2 text-sm font-medium transition duration-200">PRICING & FEES</a>
                    <a href="availability.html" class="border-b-2 border-transparent hover:border-brand-accent-light hover:text-white text-brand-text-light px-3 py-2 text-sm font-medium transition duration-200">AVAILABILITY</a>
                    <a href="contact.html" class="border-b-2 border-transparent hover:border-brand-accent-light hover:text-white text-brand-text-light px-3 py-2 text-sm font-medium transition duration-200">CONTACT</a>
                </div>

                <!-- Mobile Menu Button -->
                <div class="sm:hidden">
                    <button id="mobile-menu-button" class="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-white hover:bg-brand-accent-dark focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white" aria-expanded="false">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile Menu (Hidden by default) -->
        <div class="sm:hidden hidden" id="mobile-menu">
            <div class="pt-2 pb-3 space-y-1 px-2">
                <a href="index.html" class="bg-brand-accent-dark text-white block rounded-md px-3 py-2 text-base font-medium">HOME</a>
                <a href="pricing.html" class="text-brand-text-light hover:bg-brand-accent-dark block rounded-md px-3 py-2 text-base font-medium">PRICING & FEES</a>
                <a href="availability.html" class="text-brand-text-light hover:bg-brand-accent-dark block rounded-md px-3 py-2 text-base font-medium">AVAILABILITY</a>
                <a href="contact.html" class="text-brand-text-light hover:bg-brand-accent-dark block rounded-md px-3 py-2 text-base font-medium">CONTACT</a>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="max-w-6xl mx-auto px-4 py-8 sm:py-12 flex-grow">

        <!-- Hero Section -->
        <header class="text-center mb-10">
            <h1 class="font-heading text-5xl sm:text-6xl md:text-7xl font-extrabold tracking-tighter leading-tight mb-3 main-hero-shadow">
                <span class="text-brand-accent-light">Elliot Wardill</span>
                <br class="hidden sm:inline"> Mobile Music Lessons
            </h1>
            <p class="text-lg sm:text-xl text-brand-text-mid max-w-3xl mx-auto">
                Piano and Singing Lessons brought right to your home in **Pudsey**, **Leeds**, and surrounding areas.
            </p>
            <div class="mt-6 flex justify-center space-x-4">
                <a href="availability.html" class="inline-flex items-center justify-center px-5 py-2.5 border border-transparent text-base font-medium rounded-lg text-brand-dark-bg bg-brand-accent-light hover:bg-brand-accent-dark transition duration-300 transform hover:scale-[1.03] shadow-lg shadow-brand-accent-light/30">
                    <i data-lucide="clock" class="w-5 h-5 mr-2"></i> Check Availability
                </a>
                <a href="contact.html" class="inline-flex items-center justify-center px-5 py-2.5 border border-brand-highlight text-base font-medium rounded-lg text-brand-highlight hover:bg-brand-highlight/10 transition duration-300 transform hover:scale-[1.03]">
                    <i data-lucide="mail" class="w-5 h-5 mr-2"></i> Book a Lesson
                </a>
            </div>
        </header>

        <!-- Key Features Section -->
        <section class="mb-12">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                
                <!-- Feature 1: Expertise -->
                <div class="bg-card-bg p-5 rounded-xl card-glow border-t-4 border-brand-accent-light hover:border-brand-highlight transition duration-300">
                    <i data-lucide="book-open" class="w-7 h-7 text-brand-accent-light mb-2"></i>
                    <h3 class="text-lg font-semibold text-brand-text-light mb-1">Tailored Learning</h3>
                    <p class="text-brand-text-mid text-xs">Lessons are customized to your age, goals, and interests, focusing on musicality, rhythm, and performance confidence.</p>
                </div>

                <!-- Feature 2: Convenience -->
                <div class="bg-card-bg p-5 rounded-xl card-glow border-t-4 border-brand-accent-light hover:border-brand-highlight transition duration-300">
                    <i data-lucide="map-pin" class="w-7 h-7 text-brand-highlight mb-2"></i>
                    <h3 class="text-lg font-semibold text-brand-text-light mb-1">We Come To You</h3>
                    <p class="text-brand-text-mid text-xs">Enjoy lessons in the comfort of your own home. All necessary equipment, including a keyboard, is provided.</p>
                </div>

                <!-- Feature 3: Safety -->
                <div class="bg-card-bg p-5 rounded-xl card-glow border-t-4 border-brand-accent-light hover:border-brand-highlight transition duration-300">
                    <i data-lucide="zap" class="w-7 h-7 text-brand-accent-light mb-2"></i>
                    <h3 class="text-lg font-semibold text-brand-text-light mb-1">Fully Vetted</h3>
                    <p class="text-brand-text-mid text-xs">I hold a valid **DBS check** for working with children, ensuring a safe and inspiring learning environment.</p>
                </div>
            </div>
        </section>

        <!-- LLM Q&A Chat Section -->
        <section class="bg-card-bg p-5 sm:p-6 rounded-xl card-glow border border-brand-accent-dark/50">
            <h2 class="font-heading text-2xl font-bold text-brand-highlight mb-5 text-center border-b border-brand-accent-dark pb-3">
                Quick Q&A Assistant
            </h2>
            <!-- Chat Box with A11Y improvement: aria-live region -->
            <div id="chat-box" class="h-72 overflow-y-auto p-4 mb-3 rounded-lg bg-brand-dark-bg border border-brand-accent-dark/50 space-y-3" role="log" aria-live="polite" aria-atomic="false">
                <!-- Initial Bot Message -->
                <div class="flex justify-start">
                    <div class="max-w-[75%] bg-brand-accent-light/20 text-brand-text-light p-3 rounded-xl rounded-tl-none text-sm shadow">
                        Hello! I'm your assistant. Ask me anything about Elliot's lessons, policies, or availability!
                    </div>
                </div>
                <!-- Chat messages will be appended here -->
                <div id="loading-indicator" class="hidden flex justify-start">
                    <div class="max-w-[75%] bg-brand-highlight/20 text-brand-highlight p-3 rounded-xl rounded-tl-none text-sm shadow flex items-center">
                        <i data-lucide="loader-2" class="w-4 h-4 mr-2 animate-spin"></i> Thinking...
                    </div>
                </div>
            </div>

            <form id="chat-form" class="flex gap-2">
                <input type="text" id="chat-input" placeholder="e.g., What is the cost for a 60-minute lesson?" class="flex-grow p-3 rounded-lg bg-brand-dark-bg border border-brand-text-mid/50 focus:outline-none text-brand-text-light transition duration-200 text-sm" required>
                <button type="submit" id="send-button" class="bg-brand-highlight text-brand-dark-bg p-3 rounded-lg font-semibold hover:bg-brand-highlight/80 transition duration-200 flex items-center justify-center w-10 h-10" aria-label="Send message">
                    <i data-lucide="send" class="w-5 h-5"></i>
                </button>
            </form>
            <p id="error-message" class="text-xs text-red-400 mt-2 hidden" role="alert"></p>
        </section>

    </main>

    <!-- Footer -->
    <footer class="bg-gray-900 text-brand-text-mid py-6 mt-8 flex-shrink-0">
        <div class="max-w-6xl mx-auto px-4 text-center text-sm">
            <p>&copy; 2024 Elliot Wardill Mobile Music Lessons. All rights reserved.</p>
            <p class="mt-2 text-gray-500">DBS Checked & Insured. Policy documents available upon request.</p>
        </div>
    </footer>
    
    <!-- JavaScript for Mobile Menu and Advanced API Interaction with History -->
    <script>
        // IIFE for scope management and advanced logic
        (function() {
            // Mobile Menu Toggle
            document.getElementById('mobile-menu-button').addEventListener('click', function() {
                var menu = document.getElementById('mobile-menu');
                menu.classList.toggle('hidden');
            });

            // --- LLM Q&A Chat Logic ---
            const CHAT_HISTORY_KEY = 'elliot_music_chat_history';
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');
            const chatBox = document.getElementById('chat-box');
            const loadingIndicator = document.getElementById('loading-indicator');
            const errorMessage = document.getElementById('error-message');
            const sendButton = document.getElementById('send-button');

            // Global chat history array used for session management and persistence
            let chatHistory = []; 

            const apiKey = "" 
            const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
            
            // System instruction remains the same, but it's now wrapped for clarity in the JS module
            const systemPrompt = `You are a helpful and friendly Q&A assistant for Elliot Wardill's Mobile Music Lessons. 
            Your goal is to answer user questions concisely and clearly, based *only* on the provided context.
            
            **Context:**
            - **Instructor:** Elliot Wardill.
            - **Services:** Piano and Singing Lessons.
            - **Delivery:** Lessons are mobile (at the student's home). Elliot brings necessary equipment (including a keyboard).
            - **Areas Served:** Pudsey, Farsley, Calverley, Bramley, Horsforth, and Leeds.
            - **Travel Fees:** 5 Miles +: £5; 10 Miles +: £10; 15 Miles +: £20-£30.
            - **Fees (Standard Lessons):** 30 minutes: £15; 60 minutes: £30; 90 minutes: £50. First lesson introductory offer: £10.
            - **Payment:** Cash at the lesson or bank transfer in advance.
            - **Cancellation Policy:** At least 24 hours' notice required. Less than 24 hours' notice may be charged 50% of the lesson fee.
            - **Availability:** Tuesday (6pm-9pm), Wednesday (6pm-9pm), Thursday (6pm-9pm). Saturday & Sunday are available upon request. Monday & Friday have no available slots.
            - **Safety:** Instructor holds a valid DBS check. Parents/guardians are welcome to sit in.
            - **Safeguarding (Stanningley Primary School):** Any information disclosed by a child enrolled there will be reported directly to school authorities.

            Keep responses brief and directly answer the user's query using the details above.`;

            // Helper function to append message to chat box UI
            function appendMessageToUI(sender, text) {
                const messageContainer = document.createElement('div');
                messageContainer.classList.add('flex', sender === 'user' ? 'justify-end' : 'justify-start');

                const bubble = document.createElement('div');
                bubble.classList.add(
                    'max-w-[75%]', 'p-3', 'rounded-xl', 'text-sm', 'shadow'
                );

                if (sender === 'user') {
                    bubble.classList.add('bg-brand-highlight', 'text-brand-dark-bg', 'rounded-tr-none');
                } else {
                    bubble.classList.add('bg-brand-accent-light/20', 'text-brand-text-light', 'rounded-tl-none');
                }

                bubble.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Simple markdown bolding

                // Add the message *before* the loading indicator
                chatBox.insertBefore(messageContainer, loadingIndicator);
                chatBox.scrollTop = chatBox.scrollHeight;
            }

            // Function to save chat history to localStorage
            function saveChatHistory() {
                try {
                    // Only save the user/model parts of the history, not the initial system prompt
                    const serializableHistory = chatHistory.filter(msg => msg.role !== 'system');
                    localStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(serializableHistory));
                } catch (e) {
                    console.error("Could not save chat history to localStorage:", e);
                }
            }

            // Function to load and display chat history from localStorage
            function loadChatHistory() {
                try {
                    const savedHistory = localStorage.getItem(CHAT_HISTORY_KEY);
                    if (savedHistory) {
                        const parsedHistory = JSON.parse(savedHistory);
                        chatHistory = parsedHistory; // Restore history array
                        
                        // Display restored history in UI
                        parsedHistory.forEach(message => {
                            if (message.role === 'user') {
                                appendMessageToUI('user', message.parts[0].text);
                            } else if (message.role === 'model') {
                                appendMessageToUI('bot', message.parts[0].text);
                            }
                        });

                        // Add a history-loaded indicator message
                        const historyMessage = document.createElement('div');
                        historyMessage.classList.add('text-center', 'text-brand-text-mid', 'text-xs', 'py-1');
                        historyMessage.innerHTML = '<i data-lucide="history" class="w-3 h-3 inline-block mr-1 align-sub"></i> Conversation loaded from history.';
                        chatBox.insertBefore(historyMessage, loadingIndicator);

                    }
                } catch (e) {
                    console.error("Could not load chat history from localStorage:", e);
                    // Clear corrupted history if parsing fails
                    localStorage.removeItem(CHAT_HISTORY_KEY);
                }
            }


            // Fetch data from Gemini API with exponential backoff (improved)
            async function fetchWithBackoff(url, options, retries = 3) {
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(url, options);
                        if (response.status === 403) {
                            throw new Error(`API Error: Forbidden (Status 403). Permissions issue.`);
                        }
                        if (!response.ok) {
                            throw new Error(`API request failed with status ${response.status}`);
                        }
                        return response;
                    } catch (error) {
                        if (i === retries - 1) {
                            throw error; // Throw final error
                        }
                        // Exponential backoff delay
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }


            async function handleQuery(query) {
                sendButton.disabled = true;
                loadingIndicator.classList.remove('hidden');
                errorMessage.classList.add('hidden');
                chatBox.scrollTop = chatBox.scrollHeight;

                // 1. Add user message to history
                const userMessage = { role: "user", parts: [{ text: query }] };
                chatHistory.push(userMessage);

                // 2. Build contents array including all history
                const contents = [
                    // System instructions must be added to the request payload, NOT the chat history array
                    { parts: [{ text: systemPrompt }], role: "system" }, 
                    ...chatHistory.filter(msg => msg.role !== 'system') // Filter out the initial system part from the array
                ];

                const payload = {
                    contents: contents,
                    // tools property is outside contents array
                    tools: [{ "google_search": {} }], 
                };

                const options = {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                };

                try {
                    const urlWithKey = `${API_URL}?key=${apiKey}`;
                    const response = await fetchWithBackoff(urlWithKey, options);
                    const result = await response.json();

                    const botCandidate = result.candidates?.[0];
                    const text = botCandidate?.content?.parts?.[0]?.text;

                    if (text) {
                        // 3. Add model response to history and UI
                        const modelMessage = { role: "model", parts: [{ text: text }] };
                        chatHistory.push(modelMessage);
                        appendMessageToUI('bot', text);
                        saveChatHistory(); // Save after successful response
                    } else {
                        // Handle cases where response is OK but content is missing
                        appendMessageToUI('bot', "I couldn't generate a response for that. Please try a different question.");
                    }

                } catch (error) {
                    console.error("Gemini API Error:", error);
                    errorMessage.textContent = `Error: The Q&A service failed. Please try again.`;
                    errorMessage.classList.remove('hidden');
                    // Remove the last user message from history if the API call failed
                    chatHistory.pop(); 
                    appendMessageToUI('bot', "I apologize, but I'm currently unable to connect to the Q&A service.");
                } finally {
                    loadingIndicator.classList.add('hidden');
                    sendButton.disabled = false;
                }
            }

            chatForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const query = chatInput.value.trim();
                if (query) {
                    appendMessageToUI('user', query);
                    handleQuery(query);
                    chatInput.value = '';
                }
            });

            // Initialize on Load
            document.addEventListener('DOMContentLoaded', () => {
                loadChatHistory();
            });

        })(); // End of IIFE
    </script>
</body>
</html>
