<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin ‚Äì Elliot's Mobile Music Lessons</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="/favicon.png" type="image/png" />

  <!-- Tailwind CDN (fine for now while developing) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'brand-dark-bg': '#1a1a2e',
            'brand-accent-light': '#00d084',
            'brand-accent-dark': '#00a36e',
            'brand-text-light': '#e0e0e0',
            'brand-text-mid': '#a0a0a0',
            'brand-highlight': '#ffb703',
            'card-bg': '#252538',
            'error-red': '#f87171',
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
            heading: ['Montserrat', 'sans-serif'],
          },
        }
      }
    }
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Montserrat:wght@700;800;900&display=swap');

    html { -webkit-text-size-adjust: 100%; }
    body {
      font-family: 'Inter', sans-serif;
      background-color: #1a1a2e;
      color: #e0e0e0;
      background-image: radial-gradient(circle at 100% 100%, #252538 0%, #1a1a2e 70%);
      padding-bottom: env(safe-area-inset-bottom);
    }

    .card-glow { box-shadow: 0 0 30px rgba(0, 208, 132, 0.15); }

    .tab-active {
      border-color: #00d084;
      background-color: rgba(0, 208, 132, 0.1);
      color: #e0e0e0;
    }
    .tab-inactive {
      border-color: rgba(160, 160, 190, 0.3);
      background-color: transparent;
      color: #a0a0a0;
    }

    .pill-badge {
      border-radius: 999px;
      padding: 0.1rem 0.6rem;
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 700;
      border-width: 1px;
      line-height: 1.25;
      white-space: nowrap;
    }

    /* Quill styling */
    .ql-toolbar.ql-snow {
      border-radius: 0.75rem 0.75rem 0 0;
      border: 1px solid #3b3b5a;
      background: #1a1a2e;
      color: #e0e0e0;
    }
    .ql-container.ql-snow {
      border-radius: 0 0 0.75rem 0.75rem;
      border: 1px solid #3b3b5a;
      background: #1a1a2e;
      color: #e0e0e0;
      min-height: 180px;
    }
    .ql-editor { min-height: 180px; }

    /* Scrollbars */
    .scroll-skinny::-webkit-scrollbar { width: 6px; height: 6px; }
    .scroll-skinny::-webkit-scrollbar-track { background: rgba(37, 37, 56, 0.8); }
    .scroll-skinny::-webkit-scrollbar-thumb {
      background: rgba(0, 208, 132, 0.6);
      border-radius: 999px;
    }

    /* Modal/Drawer overlay */
    .overlay {
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(6px);
    }
  </style>

  <!-- Quill JS -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" />
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

  <!-- Supabase JS (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="min-h-screen flex flex-col">

  <!-- NAVIGATION -->
  <nav class="bg-brand-dark-bg/90 backdrop-blur border-b border-brand-accent-dark/40 text-white sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <!-- Logo -->
        <a href="index.html" class="flex items-center space-x-2">
          <span class="inline-flex items-center justify-center w-9 h-9 rounded-full bg-brand-accent-light/10 border border-brand-accent-light/50">
            <svg xmlns="http://www.w3.org/2000/svg"
              width="24" height="24" viewBox="0 0 24 24"
              fill="none" stroke="currentColor"
              stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round"
              class="w-5 h-5 text-brand-accent-light">
              <circle cx="8" cy="18" r="4"></circle>
              <path d="M12 18V2l7 4"></path>
            </svg>
          </span>
          <span class="text-xs sm:text-sm font-heading font-extrabold tracking-[0.18em] text-brand-highlight">
            ELLIOT'S MOBILE MUSIC ‚Äì ADMIN
          </span>
        </a>

        <!-- Right -->
        <div class="flex items-center space-x-3 text-xs sm:text-sm">
          <span
            id="admin-user-pill"
            class="hidden sm:inline-flex items-center gap-2 px-3 py-1 rounded-full bg-card-bg border border-brand-accent-dark/60 text-brand-text-mid"
          >
            <span class="w-2 h-2 rounded-full bg-brand-accent-light"></span>
            <span>Logged in‚Ä¶</span>
          </span>

          <button
            id="logout-button"
            class="px-3 py-1 rounded-lg bg-card-bg border border-brand-accent-dark/50 text-brand-text-mid hover:bg-brand-accent-dark hover:text-brand-dark-bg text-xs font-semibold transition"
          >
            Log out
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- MAIN -->
  <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-10 flex-grow">
    <!-- Global Error Banner -->
    <div id="global-error" class="hidden mb-4 p-3 rounded-lg bg-red-900/40 border border-error-red text-error-red text-sm"></div>

    <!-- Header + stats -->
    <header class="mb-6 sm:mb-8">
      <p class="text-[0.7rem] tracking-[0.22em] font-semibold text-brand-highlight uppercase mb-2">
        Internal Control Panel
      </p>

      <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-4">
        <div>
          <h1 class="font-heading text-3xl sm:text-4xl font-extrabold text-brand-text-light">
            Admin Dashboard
          </h1>
          <p class="text-sm sm:text-base text-brand-text-mid mt-1 max-w-xl">
            Manage students, newsletters, next lessons and shared resources from one place.
          </p>
        </div>

        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-xs">
          <div class="bg-card-bg/90 border border-brand-accent-dark/50 rounded-lg px-3 py-2 text-center">
            <p class="text-brand-text-mid">Total Profiles</p>
            <p id="stat-total-users" class="text-lg font-bold text-brand-accent-light">‚Äì</p>
          </div>
          <div class="bg-card-bg/90 border border-brand-accent-dark/50 rounded-lg px-3 py-2 text-center">
            <p class="text-brand-text-mid">Students</p>
            <p id="stat-students" class="text-lg font-bold text-brand-accent-light">‚Äì</p>
          </div>
          <div class="bg-card-bg/90 border border-brand-accent-dark/50 rounded-lg px-3 py-2 text-center">
            <p class="text-brand-text-mid">Admins</p>
            <p id="stat-admins" class="text-lg font-bold text-brand-highlight">‚Äì</p>
          </div>
          <div class="bg-card-bg/90 border border-brand-accent-dark/50 rounded-lg px-3 py-2 text-center">
            <p class="text-brand-text-mid">Newsletters</p>
            <p id="stat-newsletters" class="text-lg font-bold text-brand-accent-light">‚Äì</p>
          </div>
        </div>
      </div>
    </header>

    <!-- Tabs -->
    <div class="mb-6 flex flex-wrap gap-2">
      <button class="tab-btn tab-active px-4 py-2 rounded-full border text-xs sm:text-sm font-semibold" data-tab="users">
        üë§ Students & Profiles
      </button>
      <button class="tab-btn tab-inactive px-4 py-2 rounded-full border text-xs sm:text-sm font-semibold" data-tab="schedule">
        üìÖ Schedule
      </button>
      <button class="tab-btn tab-inactive px-4 py-2 rounded-full border text-xs sm:text-sm font-semibold" data-tab="newsletters">
        üì∞ Newsletters
      </button>
      <button class="tab-btn tab-inactive px-4 py-2 rounded-full border text-xs sm:text-sm font-semibold" data-tab="files">
        üìÅ Files per Student
      </button>
    </div>

    <!-- TAB: USERS -->
    <section id="tab-users" class="space-y-4">
      <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-3">
        <div class="flex-1">
          <label class="block text-xs font-semibold text-brand-text-mid mb-1">
            Search profiles
          </label>
          <!-- Mobile-friendly input size (prevents iOS zoom) -->
          <input
            id="user-search"
            type="text"
            placeholder="Name, email, phone, role, instrument, id..."
            class="w-full px-3 py-2 rounded-lg bg-brand-dark-bg border border-brand-accent-dark/50 text-base sm:text-sm focus:outline-none focus:border-brand-accent-light focus:ring-2 focus:ring-brand-accent-light/40"
          />
        </div>

        <div class="flex flex-wrap gap-2 text-xs">
          <button class="user-sort px-3 py-2 rounded-lg bg-card-bg border border-brand-accent-dark/40 hover:border-brand-accent-light" data-sort="name-asc">
            A‚ÄìZ
          </button>
          <button class="user-sort px-3 py-2 rounded-lg bg-card-bg border border-brand-accent-dark/40 hover:border-brand-accent-light" data-sort="name-desc">
            Z‚ÄìA
          </button>
          <button class="user-sort px-3 py-2 rounded-lg bg-card-bg border border-brand-accent-dark/40 hover:border-brand-accent-light" data-sort="next-lesson">
            Next lesson
          </button>
          <button class="user-sort px-3 py-2 rounded-lg bg-card-bg border border-brand-accent-dark/40 hover:border-brand-accent-light" data-sort="role">
            By role
          </button>
        </div>
      </div>

      <div class="bg-card-bg/90 border border-brand-accent-dark/60 rounded-xl card-glow overflow-hidden">
        <div class="px-4 py-3 border-b border-brand-accent-dark/50 flex justify-between items-center text-xs gap-3">
          <span class="text-brand-text-mid">
            Edit student info + next lesson + weekly slot (stored on <code>profiles</code>).
          </span>

          <div class="flex items-center gap-2">
            <span class="pill-badge bg-brand-accent-light/10 text-brand-accent-light border-brand-accent-light/40">
              ADMIN CONTROL
            </span>
          </div>
        </div>

        <!-- ONE ACTION ROOT (mobile cards + desktop table) -->
        <div id="users-actions">
          <!-- ‚úÖ MOBILE VIEW: cards -->
          <div id="users-cards" class="sm:hidden p-3 space-y-2 max-h-[560px] overflow-y-auto scroll-skinny"></div>

          <!-- ‚úÖ DESKTOP VIEW: table -->
          <div class="hidden sm:block max-h-[460px] overflow-y-auto scroll-skinny">
            <div class="overflow-x-auto">
              <table class="min-w-[860px] w-full text-xs sm:text-sm">
                <thead class="bg-brand-dark-bg/70 sticky top-0 z-10">
                  <tr>
                    <th class="px-4 py-3 text-left font-semibold text-brand-text-mid">Student</th>
                    <th class="px-4 py-3 text-left font-semibold text-brand-text-mid">Role</th>
                    <th class="px-4 py-3 text-left font-semibold text-brand-text-mid">Next lesson</th>
                    <th class="px-4 py-3 text-left font-semibold text-brand-text-mid">Weekly slot</th>
                    <th class="px-4 py-3 text-right font-semibold text-brand-text-mid">Actions</th>
                  </tr>
                </thead>
                <tbody id="users-table-body" class="divide-y divide-[#333355]"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- TAB: SCHEDULE -->
    <section id="tab-schedule" class="hidden space-y-4">
      <div class="bg-card-bg/90 border border-brand-accent-dark/60 rounded-xl card-glow p-4 sm:p-5">
        <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
          <div>
            <h2 class="font-heading text-xl font-bold text-brand-text-light">Upcoming Lessons</h2>
            <p class="text-xs sm:text-sm text-brand-text-mid">
              Sorted by <code>profiles.next_lesson_at</code>. ‚ÄúMark done‚Äù will advance weekly students to the next slot.
            </p>
          </div>

          <div class="flex flex-wrap gap-2 text-xs">
            <button id="schedule-refresh" class="px-3 py-2 rounded-lg bg-card-bg border border-brand-accent-dark/40 hover:border-brand-accent-light">
              Refresh
            </button>
            <button id="schedule-show-all" class="px-3 py-2 rounded-lg bg-card-bg border border-brand-accent-dark/40 hover:border-brand-accent-light">
              Show all
            </button>
            <button id="schedule-next-14" class="px-3 py-2 rounded-lg bg-card-bg border border-brand-accent-dark/40 hover:border-brand-accent-light">
              Next 14 days
            </button>
          </div>
        </div>

        <div class="mt-4">
          <div id="schedule-list" class="space-y-2 max-h-[520px] sm:max-h-[420px] overflow-y-auto scroll-skinny"></div>
        </div>
      </div>
    </section>

    <!-- TAB: NEWSLETTERS -->
    <section id="tab-newsletters" class="hidden space-y-4">
      <div class="grid grid-cols-1 lg:grid-cols-[1.5fr_minmax(0,1.1fr)] gap-5">
        <!-- Editor -->
        <div class="bg-card-bg/90 border border-brand-accent-dark/60 rounded-xl card-glow p-4 sm:p-5">
          <div class="flex items-center justify-between mb-3 gap-3">
            <div>
              <h2 class="font-heading text-xl font-bold text-brand-text-light">Newsletter Editor</h2>
              <p class="text-xs text-brand-text-mid">Write updates that will appear on student portals.</p>
            </div>
            <span class="pill-badge bg-brand-accent-light/10 text-brand-accent-light border-brand-accent-light/40">
              DRAFT / PUBLISH
            </span>
          </div>

          <div class="mb-3">
            <label class="text-xs font-semibold text-brand-text-mid mb-1 block">Title</label>
            <input
              id="newsletter-title"
              type="text"
              placeholder="e.g. January Piano Progress & Holiday Updates"
              class="w-full px-3 py-2 rounded-lg bg-brand-dark-bg border border-brand-accent-dark/50 text-base sm:text-sm focus:outline-none focus:border-brand-accent-light focus:ring-2 focus:ring-brand-accent-light/40"
            />
          </div>

          <div class="mb-3">
            <label class="text-xs font-semibold text-brand-text-mid mb-1 block">Content</label>
            <div id="newsletter-editor"></div>
          </div>

          <div class="flex flex-wrap gap-2 mt-3 text-xs">
            <button
              id="newsletter-save-draft"
              class="px-4 py-2 rounded-lg bg-card-bg border border-brand-accent-dark/60 hover:border-brand-accent-light text-brand-text-mid font-semibold"
            >
              üíæ Save Draft
            </button>
            <button
              id="newsletter-publish"
              class="px-4 py-2 rounded-lg bg-brand-accent-light hover:bg-brand-accent-dark text-brand-dark-bg font-semibold"
            >
              üöÄ Publish & Notify
            </button>
            <button
              id="newsletter-clear"
              class="px-3 py-2 rounded-lg bg-card-bg border border-brand-accent-dark/60 text-brand-text-mid hover:text-error-red hover:border-error-red"
            >
              Clear
            </button>
          </div>

          <p class="mt-3 text-[0.7rem] text-brand-text-mid">
            Published entries should be shown on the student portal homepage.
          </p>
        </div>

        <!-- List + preview -->
        <div class="space-y-4">
          <div class="bg-card-bg/90 border border-brand-accent-dark/60 rounded-xl card-glow p-4 sm:p-5">
            <div class="flex items-center justify-between mb-3">
              <h3 class="font-heading text-lg font-bold text-brand-text-light">Previous Newsletters</h3>
              <button
                id="newsletter-refresh"
                class="text-xs px-3 py-1 rounded-lg bg-card-bg border border-brand-accent-dark/60 text-brand-text-mid hover:border-brand-accent-light"
              >
                Refresh
              </button>
            </div>
            <div id="newsletter-list" class="space-y-2 max-h-56 overflow-y-auto scroll-skinny text-xs sm:text-sm"></div>
          </div>

          <div class="bg-card-bg/90 border border-brand-accent-dark/60 rounded-xl card-glow p-4 sm:p-5">
            <h3 class="font-heading text-lg font-bold text-brand-text-light mb-2">Live Preview</h3>
            <h4 id="newsletter-preview-title" class="text-sm font-semibold text-brand-highlight mb-1">(Title will appear here)</h4>
            <div id="newsletter-preview-body" class="prose prose-invert max-w-none text-xs sm:text-sm text-brand-text-mid">
              Start typing in the editor to see a preview...
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- TAB: FILES -->
    <section id="tab-files" class="hidden space-y-4">
      <div class="bg-card-bg/90 border border-brand-accent-dark/60 rounded-xl card-glow p-4 sm:p-5">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
          <div>
            <h2 class="font-heading text-xl font-bold text-brand-text-light">Upload Files for a Student</h2>
            <p class="text-xs sm:text-sm text-brand-text-mid">
              Sheet music, lesson plans, PDFs, backing tracks etc. stored as <code>student_files/{student_id}/</code>.
            </p>
          </div>
          <span class="pill-badge bg-brand-accent-light/10 text-brand-accent-light border-brand-accent-light/40">
            Storage: student_files
          </span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-[1.2fr_minmax(0,1fr)] gap-4">
          <div>
            <label class="block text-xs font-semibold text-brand-text-mid mb-1">Choose student profile</label>
            <select
              id="files-student-select"
              class="w-full px-3 py-2 rounded-lg bg-brand-dark-bg border border-brand-accent-dark/50 text-base sm:text-sm focus:outline-none focus:border-brand-accent-light focus:ring-2 focus:ring-brand-accent-light/40"
            >
              <option value="">Select a student...</option>
            </select>
            <p class="text-[0.7rem] text-brand-text-mid mt-1">List comes from <code>profiles</code>.</p>
          </div>

          <div>
            <label class="block text-xs font-semibold text-brand-text-mid mb-1">File</label>
            <input
              id="file-input"
              type="file"
              class="block w-full text-xs text-brand-text-mid file:mr-3 file:py-2 file:px-3 file:rounded-lg file:border-0 file:bg-brand-accent-light file:text-brand-dark-bg hover:file:bg-brand-accent-dark"
            />
            <p class="text-[0.7rem] text-brand-text-mid mt-1">
              Uploaded to <code>student_files/{student_id}/</code>.
            </p>
          </div>
        </div>

        <div class="mt-4">
          <button
            id="upload-file-button"
            class="w-full sm:w-auto px-4 py-2 rounded-lg bg-brand-accent-light hover:bg-brand-accent-dark text-brand-dark-bg text-sm font-semibold"
          >
            ‚¨Ü Upload File for Student
          </button>
        </div>
      </div>

      <div class="bg-card-bg/90 border border-brand-accent-dark/60 rounded-xl card-glow p-4 sm:p-5">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-heading text-lg font-bold text-brand-text-light">Files for Selected Student</h3>
          <span class="text-[0.7rem] text-brand-text-mid hidden sm:inline">Signed URLs used (works with private bucket).</span>
        </div>
        <div id="file-list" class="space-y-2 max-h-80 sm:max-h-72 overflow-y-auto scroll-skinny text-xs sm:text-sm">
          <p class="text-brand-text-mid text-sm">Select a student above to view their attached files.</p>
        </div>
      </div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="bg-gray-900 text-brand-text-mid py-6 mt-8 flex-shrink-0">
    <div class="max-w-6xl mx-auto px-4 text-center text-xs sm:text-sm">
      <p>&copy; 2024 Elliot Wardill Mobile Music Lessons. All rights reserved.</p>
      <p class="mt-2 text-gray-500">Internal admin area ‚Äî not visible to parents or students.</p>
    </div>
  </footer>

  <!-- EDIT STUDENT DRAWER -->
  <div id="edit-overlay" class="hidden fixed inset-0 z-[100] overlay"></div>

  <aside
    id="edit-drawer"
    class="hidden fixed top-0 right-0 h-full w-full sm:w-[520px] z-[101]
           bg-brand-dark-bg border-l border-brand-accent-dark/60 shadow-2xl"
  >
    <div class="h-full flex flex-col">
      <div class="px-5 py-4 border-b border-brand-accent-dark/50 flex items-start justify-between gap-4">
        <div>
          <h3 class="font-heading text-xl font-extrabold text-brand-text-light">Edit Student</h3>
          <p class="text-xs text-brand-text-mid mt-1" id="edit-subtitle">‚Äî</p>
        </div>
        <button
          id="edit-close"
          class="px-3 py-2 rounded-lg bg-card-bg border border-brand-accent-dark/60 text-brand-text-mid hover:border-brand-accent-light"
        >
          Close
        </button>
      </div>

      <div class="flex-1 overflow-y-auto scroll-skinny px-5 py-5 space-y-4">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div>
            <label class="block text-xs font-semibold text-brand-text-mid mb-1">Full name</label>
            <input id="edit-full-name" type="text"
              class="w-full px-3 py-2 rounded-lg bg-brand-dark-bg border border-brand-accent-dark/50 text-base sm:text-sm focus:outline-none focus:border-brand-accent-light focus:ring-2 focus:ring-brand-accent-light/40"
              placeholder="Student name" />
          </div>
          <div>
            <label class="block text-xs font-semibold text-brand-text-mid mb-1">Instrument</label>
            <input id="edit-instrument" type="text"
              class="w-full px-3 py-2 rounded-lg bg-brand-dark-bg border border-brand-accent-dark/50 text-base sm:text-sm focus:outline-none focus:border-brand-accent-light focus:ring-2 focus:ring-brand-accent-light/40"
              placeholder="Piano / Singing / Guitar..." />
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div>
            <label class="block text-xs font-semibold text-brand-text-mid mb-1">Email (profile)</label>
            <input id="edit-email" type="email"
              class="w-full px-3 py-2 rounded-lg bg-brand-dark-bg border border-brand-accent-dark/50 text-base sm:text-sm focus:outline-none focus:border-brand-accent-light focus:ring-2 focus:ring-brand-accent-light/40"
              placeholder="parent@email.com" />
            <p class="text-[0.7rem] text-brand-text-mid mt-1">
              This edits <code>profiles.email</code> (not Supabase Auth email).
            </p>
          </div>
          <div>
            <label class="block text-xs font-semibold text-brand-text-mid mb-1">Phone</label>
            <input id="edit-phone" type="tel"
              class="w-full px-3 py-2 rounded-lg bg-brand-dark-bg border border-brand-accent-dark/50 text-base sm:text-sm focus:outline-none focus:border-brand-accent-light focus:ring-2 focus:ring-brand-accent-light/40"
              placeholder="07..." />
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div>
            <label class="block text-xs font-semibold text-brand-text-mid mb-1">Status</label>
            <select id="edit-status"
              class="w-full px-3 py-2 rounded-lg bg-brand-dark-bg border border-brand-accent-dark/50 text-base sm:text-sm focus:outline-none focus:border-brand-accent-light focus:ring-2 focus:ring-brand-accent-light/40">
              <option value="active">Active</option>
              <option value="paused">Paused</option>
              <option value="inactive">Inactive</option>
              <option value="suspended">Suspended</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-semibold text-brand-text-mid mb-1">Lesson duration (minutes)</label>
            <input id="edit-duration" type="number" min="10" step="5"
              class="w-full px-3 py-2 rounded-lg bg-brand-dark-bg border border-brand-accent-dark/50 text-base sm:text-sm focus:outline-none focus:border-brand-accent-light focus:ring-2 focus:ring-brand-accent-light/40"
              placeholder="30" />
          </div>
        </div>

        <div class="bg-card-bg/70 border border-brand-accent-dark/50 rounded-xl p-4">
          <div class="flex items-center justify-between gap-3">
            <h4 class="font-heading text-base font-bold text-brand-text-light">Next Lesson</h4>
            <span class="pill-badge bg-brand-accent-light/10 text-brand-accent-light border-brand-accent-light/40">VISIBLE TO STUDENT</span>
          </div>

          <div class="mt-3">
            <label class="block text-xs font-semibold text-brand-text-mid mb-1">Next lesson date/time</label>
            <input id="edit-next-lesson" type="datetime-local"
              class="w-full px-3 py-2 rounded-lg bg-brand-dark-bg border border-brand-accent-dark/50 text-base sm:text-sm focus:outline-none focus:border-brand-accent-light focus:ring-2 focus:ring-brand-accent-light/40" />
            <p class="text-[0.7rem] text-brand-text-mid mt-1">
              Stored in <code>profiles.next_lesson_at</code>.
            </p>
          </div>

          <div class="mt-4 border-t border-brand-accent-dark/40 pt-4">
            <div class="flex items-center justify-between">
              <h4 class="font-heading text-base font-bold text-brand-text-light">Weekly Slot</h4>
              <label class="inline-flex items-center gap-2 text-xs text-brand-text-mid">
                <input id="edit-weekly-enabled" type="checkbox" class="accent-brand-accent-light" />
                Weekly recurring
              </label>
            </div>

            <div id="weekly-fields" class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3 hidden">
              <div>
                <label class="block text-xs font-semibold text-brand-text-mid mb-1">Day of week</label>
                <select id="edit-weekly-day"
                  class="w-full px-3 py-2 rounded-lg bg-brand-dark-bg border border-brand-accent-dark/50 text-base sm:text-sm focus:outline-none focus:border-brand-accent-light focus:ring-2 focus:ring-brand-accent-light/40">
                  <option value="1">Monday</option>
                  <option value="2">Tuesday</option>
                  <option value="3">Wednesday</option>
                  <option value="4">Thursday</option>
                  <option value="5">Friday</option>
                  <option value="6">Saturday</option>
                  <option value="0">Sunday</option>
                </select>
              </div>

              <div>
                <label class="block text-xs font-semibold text-brand-text-mid mb-1">Time</label>
                <input id="edit-weekly-time" type="time"
                  class="w-full px-3 py-2 rounded-lg bg-brand-dark-bg border border-brand-accent-dark/50 text-base sm:text-sm focus:outline-none focus:border-brand-accent-light focus:ring-2 focus:ring-brand-accent-light/40" />
              </div>

              <div class="sm:col-span-2 flex flex-col sm:flex-row flex-wrap gap-2 pt-1">
                <button id="edit-calc-next"
                  class="w-full sm:w-auto px-3 py-2 rounded-lg bg-brand-accent-light hover:bg-brand-accent-dark text-brand-dark-bg text-xs font-semibold">
                  Calculate next lesson from weekly slot
                </button>
                <button id="edit-clear-next"
                  class="w-full sm:w-auto px-3 py-2 rounded-lg bg-card-bg border border-error-red/60 text-error-red hover:bg-red-900/40 text-xs font-semibold">
                  Clear next lesson
                </button>
              </div>

              <p class="sm:col-span-2 text-[0.7rem] text-brand-text-mid">
                Weekly slot is stored in <code>profiles.weekly_day</code> + <code>profiles.weekly_time</code> + <code>profiles.weekly_enabled</code>.
              </p>
            </div>
          </div>
        </div>

        <div>
          <label class="block text-xs font-semibold text-brand-text-mid mb-1">Admin notes (private)</label>
          <textarea id="edit-notes" rows="4"
            class="w-full px-3 py-2 rounded-lg bg-brand-dark-bg border border-brand-accent-dark/50 text-base sm:text-sm focus:outline-none focus:border-brand-accent-light focus:ring-2 focus:ring-brand-accent-light/40"
            placeholder="Anything helpful: goals, parent preferences, cancellations, etc."></textarea>
          <p class="text-[0.7rem] text-brand-text-mid mt-1">
            Stored as <code>profiles.admin_notes</code> (only show to admin).
          </p>
        </div>
      </div>

      <div class="px-5 py-4 border-t border-brand-accent-dark/50 flex items-center justify-between gap-3">
        <button id="edit-cancel"
          class="px-4 py-2 rounded-lg bg-card-bg border border-brand-accent-dark/60 text-brand-text-mid hover:border-brand-accent-light text-sm font-semibold">
          Cancel
        </button>

        <div class="flex items-center gap-2">
          <button id="edit-save"
            class="px-4 py-2 rounded-lg bg-brand-accent-light hover:bg-brand-accent-dark text-brand-dark-bg text-sm font-semibold">
            Save changes
          </button>
        </div>
      </div>
    </div>
  </aside>

  <!-- ADMIN LOGIC -->
  <script>
    // ============================
    // Supabase config
    // ============================
    const SUPABASE_URL = "https://gorrhpliwhpznmdqhzjo.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdvcnJocGxpd2hwem5tZHFoempvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxMzAxMzYsImV4cCI6MjA4MDcwNjEzNn0.lqQGk_KT4kQQyqGJA-P8nZr1ksE5NOQvzpvYPD1JYGM";

    // ‚úÖ IMPORTANT: bucket name must match Supabase Storage EXACTLY
    const STUDENT_FILES_BUCKET = "STUDENT-FILES";

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      db: { schema: "public" },
    });

    // ============================
    // Redirect loop protection (GLOBAL, single instance)
    // ============================
    if (!window.__emmRedirectState) window.__emmRedirectState = { active: false };
    function safeRedirect(url) {
      if (window.__emmRedirectState.active) return;
      window.__emmRedirectState.active = true;
      window.location.replace(url);
    }

    // Global state
    let currentAdminUser = null;
    let currentAdminProfile = null;

    let allProfiles = [];
    let filteredProfiles = [];

    let quill = null;
    let currentNewsletterId = null;

    // Drawer editing state
    let editProfileId = null;

    // Schedule filter
    let scheduleMode = "14"; // "14" or "all"

    const $ = (id) => document.getElementById(id);

    function showGlobalError(message) {
      const box = $("global-error");
      if (!box) return;
      box.textContent = message;
      box.classList.remove("hidden");
      box.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    function hideGlobalError() {
      const box = $("global-error");
      if (!box) return;
      box.classList.add("hidden");
      box.textContent = "";
    }

    function formatDate(value) {
      if (!value) return "‚Äì";
      const d = new Date(value);
      if (isNaN(d.getTime())) return "‚Äì";
      return d.toLocaleString("en-GB", {
        weekday: "short",
        year: "numeric",
        month: "short",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
      });
    }

    function shortId(id) {
      if (!id) return "‚Äì";
      return id.slice(0, 8) + "‚Ä¶";
    }

    function toDatetimeLocalValue(isoString) {
      if (!isoString) return "";
      const d = new Date(isoString);
      if (isNaN(d.getTime())) return "";
      const pad = (n) => String(n).padStart(2, "0");
      const yyyy = d.getFullYear();
      const mm = pad(d.getMonth() + 1);
      const dd = pad(d.getDate());
      const hh = pad(d.getHours());
      const mi = pad(d.getMinutes());
      return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
    }

    function fromDatetimeLocalValue(localValue) {
      if (!localValue) return null;
      const d = new Date(localValue);
      if (isNaN(d.getTime())) return null;
      return d.toISOString();
    }

    function normalizePhone(phone) {
      if (!phone) return "";
      return String(phone).trim();
    }

    function safeText(s) {
      return (s ?? "").toString();
    }

    // ============================
    // Weekly helper
    // ============================
    function computeNextOccurrence(weeklyDay, weeklyTime) {
      if (weeklyDay === null || weeklyDay === undefined) return null;
      if (!weeklyTime || !weeklyTime.includes(":")) return null;

      const [hh, mm] = weeklyTime.split(":").map((x) => parseInt(x, 10));
      if (Number.isNaN(hh) || Number.isNaN(mm)) return null;

      const now = new Date();
      const target = new Date(now);
      target.setSeconds(0, 0);
      target.setHours(hh, mm, 0, 0);

      const currentDay = now.getDay();
      let deltaDays = (weeklyDay - currentDay + 7) % 7;
      if (deltaDays === 0 && target <= now) deltaDays = 7;

      target.setDate(target.getDate() + deltaDays);
      return target;
    }

    // ============================
    // Suspend / Reactivate + Delete
    // ============================
    function isSuspendedStatus(status) {
      const s = (status || "active").toLowerCase();
      return s === "paused" || s === "inactive" || s === "suspended";
    }

    async function setStudentStatus(profileId, newStatus) {
      hideGlobalError();

      const { error } = await supabaseClient
        .from("profiles")
        .update({
          status: newStatus,
          ...(newStatus !== "active"
            ? { next_lesson_at: null, weekly_enabled: false, weekly_day: null, weekly_time: null }
            : {}),
          updated_at: new Date().toISOString(),
        })
        .eq("id", profileId);

      if (error) {
        console.error(error);
        showGlobalError("Failed to update student status. Check RLS + profiles columns.");
        return;
      }

      await loadProfiles();
    }

    async function deleteStudent(profileId) {
      hideGlobalError();

      if (currentAdminUser?.id === profileId) {
        showGlobalError("You can‚Äôt delete your own admin account from here.");
        return;
      }

      const p = allProfiles.find((x) => x.id === profileId);
      const name = p?.full_name || p?.username || p?.email || shortId(profileId);

      if (!confirm(`Delete "${name}"?\n\nThis will:\n‚Ä¢ Delete their profile row\n‚Ä¢ Attempt to delete student files in ${STUDENT_FILES_BUCKET}/${profileId}/\n\nIt will NOT delete their Supabase Auth login (that requires a service-role Edge Function).`)) {
        return;
      }

      // 1) Delete student folder contents (best effort)
      try {
        let offset = 0;
        const limit = 100;
        const toRemove = [];

        while (true) {
          const { data, error } = await supabaseClient.storage
            .from(STUDENT_FILES_BUCKET)
            .list(`${profileId}/`, { limit, offset });

          if (error) {
            console.warn("Could not list files for deletion:", error);
            break;
          }

          if (!data || data.length === 0) break;

          for (const f of data) {
            if (f?.name) toRemove.push(`${profileId}/${f.name}`);
          }

          if (data.length < limit) break;
          offset += limit;
        }

        if (toRemove.length) {
          const { error: rmErr } = await supabaseClient.storage
            .from(STUDENT_FILES_BUCKET)
            .remove(toRemove);

          if (rmErr) console.warn("Could not remove some files:", rmErr);
        }
      } catch (e) {
        console.warn("Storage delete exception:", e);
      }

      // 2) Delete profile row
      const { error } = await supabaseClient
        .from("profiles")
        .delete()
        .eq("id", profileId);

      if (error) {
        console.error(error);
        showGlobalError("Failed to delete student profile. Check RLS on profiles.");
        return;
      }

      await loadProfiles();
    }

    // ============================
    // AUTH + ADMIN CHECK
    // ============================
    async function ensureAdmin() {
      hideGlobalError();

      const { data, error } = await supabaseClient.auth.getUser();
      if (error || !data?.user) {
        safeRedirect("login.html");
        return false;
      }

      currentAdminUser = data.user;

      const { data: profile, error: profileError } = await supabaseClient
        .from("profiles")
        .select("*")
        .eq("id", currentAdminUser.id)
        .single();

      if (profileError || !profile) {
        console.error(profileError);
        showGlobalError("Your profile could not be loaded. Make sure a row exists in the profiles table.");
        return false;
      }

      currentAdminProfile = profile;

      if (profile.role !== "admin") {
        safeRedirect("portal.html");
        return false;
      }

      const pill = $("admin-user-pill");
      if (pill) {
        const name = profile.full_name || profile.username || currentAdminUser.email || "Admin user";
        pill.innerHTML = `
          <span class="w-2 h-2 rounded-full bg-brand-accent-light"></span>
          <span>${name}</span>
          <span class="pill-badge bg-brand-accent-light/10 text-brand-accent-light border-brand-accent-light/40 ml-2">ADMIN</span>
        `;
        pill.classList.remove("hidden");
      }

      return true;
    }

    // ============================
    // PROFILES
    // ============================
    async function loadProfiles() {
      hideGlobalError();

      const { data, error } = await supabaseClient
        .from("profiles")
        .select("*");

      if (error) {
        console.error(error);
        showGlobalError("Could not load profiles from Supabase. Check the profiles table + RLS policies.");
        return;
      }

      allProfiles = Array.isArray(data) ? data : [];
      filteredProfiles = [...allProfiles];

      updateStats();
      renderUsers();          // ‚úÖ renders mobile + desktop
      populateStudentSelect();
      renderSchedule();
    }

    function updateStats() {
      $("stat-total-users").textContent = allProfiles.length.toString();
      const admins = allProfiles.filter((p) => (p.role || "student") === "admin").length;
      const students = allProfiles.filter((p) => (p.role || "student") !== "admin").length;
      $("stat-admins").textContent = admins.toString();
      $("stat-students").textContent = students.toString();
    }

    function roleBadge(role) {
      const r = (role || "student").toLowerCase();
      if (r === "admin") return `<span class="pill-badge bg-brand-highlight/15 text-brand-highlight border-brand-highlight/60">ADMIN</span>`;
      if (r === "pending") return `<span class="pill-badge bg-yellow-500/10 text-yellow-300 border-yellow-500/50">PENDING</span>`;
      return `<span class="pill-badge bg-brand-accent-light/10 text-brand-accent-light border-brand-accent-light/40">STUDENT</span>`;
    }

    function statusBadge(status) {
      const s = (status || "active").toLowerCase();
      if (s === "active") return `<span class="pill-badge bg-brand-accent-light/10 text-brand-accent-light border-brand-accent-light/40">ACTIVE</span>`;
      if (s === "paused") return `<span class="pill-badge bg-yellow-500/10 text-yellow-300 border-yellow-500/50">PAUSED</span>`;
      if (s === "inactive") return `<span class="pill-badge bg-card-bg text-brand-text-mid border-brand-accent-dark/40">INACTIVE</span>`;
      if (s === "suspended") return `<span class="pill-badge bg-red-900/40 text-error-red border-error-red/60">SUSPENDED</span>`;
      return `<span class="pill-badge bg-card-bg text-brand-text-mid border-brand-accent-dark/40">${safeText(s).toUpperCase()}</span>`;
    }

    function weeklyBadge(p) {
      if (!p.weekly_enabled) return `<span class="text-[0.7rem] text-brand-text-mid">‚Äî</span>`;
      const day = Number(p.weekly_day);
      const time = p.weekly_time || "";
      const map = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
      return `
        <span class="pill-badge bg-brand-accent-light/10 text-brand-accent-light border-brand-accent-light/40">
          ${map[day] || "?"} ${time || ""}
        </span>
      `;
    }

    // ‚úÖ ONE renderer: desktop table + mobile cards
    function renderUsers() {
      const tbody = $("users-table-body");
      const cards = $("users-cards");
      tbody.innerHTML = "";
      cards.innerHTML = "";

      if (!filteredProfiles.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="px-4 py-4 text-center text-brand-text-mid text-sm">
              No profiles found yet.
            </td>
          </tr>
        `;
        cards.innerHTML = `
          <div class="px-3 py-3 rounded-lg bg-brand-dark-bg/60 border border-brand-accent-dark/50 text-brand-text-mid text-sm text-center">
            No profiles found yet.
          </div>
        `;
        return;
      }

      filteredProfiles.forEach((p) => {
        const displayName = p.full_name || p.username || "(no name set)";
        const email = p.email || "";
        const phone = p.phone || "";
        const role = (p.role || "student").toLowerCase();
        const nextLesson = p.next_lesson_at ? formatDate(p.next_lesson_at) : "‚Äî";
        const suspended = isSuspendedStatus(p.status);

        // ----- Desktop row -----
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-4 py-3 align-top">
            <div class="font-semibold text-brand-text-light">${safeText(displayName)}</div>
            <div class="text-[0.7rem] text-brand-text-mid mt-0.5 flex flex-col gap-0.5">
              ${email ? `<a class="hover:text-brand-accent-light" href="mailto:${encodeURIComponent(email)}">${safeText(email)}</a>` : `<span class="opacity-70">(no email)</span>`}
              ${phone ? `<a class="hover:text-brand-accent-light" href="tel:${encodeURIComponent(phone)}">${safeText(phone)}</a>` : ``}
              ${p.instrument ? `<span class="opacity-80">üéµ ${safeText(p.instrument)}</span>` : ``}
              ${statusBadge(p.status)}
            </div>
          </td>

          <td class="px-4 py-3 align-top">
            ${roleBadge(role)}
          </td>

          <td class="px-4 py-3 align-top text-brand-text-mid">
            <div class="text-xs sm:text-sm">${safeText(nextLesson)}</div>
          </td>

          <td class="px-4 py-3 align-top">
            ${weeklyBadge(p)}
          </td>

          <td class="px-4 py-3 align-top text-right">
            <div class="inline-flex flex-wrap gap-1 justify-end">
              <button class="px-2 py-1 rounded-md bg-brand-accent-light text-brand-dark-bg text-[0.7rem] font-semibold"
                data-action="edit" data-id="${p.id}">Edit</button>

              ${role !== "admin" ? `
                <button class="px-2 py-1 rounded-md bg-card-bg border border-brand-accent-dark/60 text-[0.7rem] text-brand-text-mid hover:border-brand-accent-light"
                  data-action="toggle-suspend" data-id="${p.id}">
                  ${suspended ? "Reactivate" : "Suspend"}
                </button>
              ` : ""}

              ${role !== "admin" ? `
                <button class="px-2 py-1 rounded-md bg-card-bg border border-error-red/60 text-[0.7rem] text-error-red hover:bg-red-900/40"
                  data-action="delete-student" data-id="${p.id}">
                  Delete
                </button>
              ` : ""}

              ${role === "pending" ? `
                <button class="px-2 py-1 rounded-md bg-brand-accent-light text-brand-dark-bg text-[0.7rem] font-semibold"
                  data-action="approve-student" data-id="${p.id}">
                  Approve
                </button>
              ` : ""}

              ${role !== "admin"
                ? `<button class="px-2 py-1 rounded-md bg-card-bg border border-brand-accent-dark/60 text-[0.7rem] text-brand-text-mid hover:border-brand-accent-light"
                    data-action="make-admin" data-id="${p.id}">
                    Make admin
                  </button>`
                : `<button class="px-2 py-1 rounded-md bg-card-bg border border-brand-accent-dark/60 text-[0.7rem] text-brand-text-mid hover:border-brand-accent-light"
                    data-action="make-student" data-id="${p.id}">
                    Make student
                  </button>`
              }
            </div>
          </td>
        `;
        tbody.appendChild(tr);

        // ----- Mobile card -----
        const card = document.createElement("div");
        card.className = "rounded-xl bg-brand-dark-bg/60 border border-brand-accent-dark/50 p-3";
        card.innerHTML = `
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <div class="font-semibold text-brand-text-light truncate">${safeText(displayName)}</div>
              <div class="mt-1 flex flex-wrap items-center gap-2">
                ${roleBadge(role)}
                ${statusBadge(p.status)}
                ${p.instrument ? `<span class="text-[0.7rem] text-brand-text-mid">üéµ ${safeText(p.instrument)}</span>` : ``}
              </div>

              <div class="mt-2 text-[0.8rem] text-brand-text-mid space-y-1">
                <div><span class="opacity-80">Next lesson:</span> <span class="text-brand-text-light/90">${safeText(nextLesson)}</span></div>
                <div><span class="opacity-80">Weekly slot:</span> ${weeklyBadge(p)}</div>
                ${email ? `<div class="break-all"><span class="opacity-80">Email:</span> <a class="hover:text-brand-accent-light" href="mailto:${encodeURIComponent(email)}">${safeText(email)}</a></div>` : ``}
                ${phone ? `<div><span class="opacity-80">Phone:</span> <a class="hover:text-brand-accent-light" href="tel:${encodeURIComponent(phone)}">${safeText(phone)}</a></div>` : ``}
              </div>
            </div>
          </div>

          <div class="mt-3 grid grid-cols-2 gap-2 text-xs">
            <button class="px-3 py-2 rounded-lg bg-brand-accent-light text-brand-dark-bg font-semibold"
              data-action="edit" data-id="${p.id}">
              Edit
            </button>

            ${role !== "admin" ? `
              <button class="px-3 py-2 rounded-lg bg-card-bg border border-brand-accent-dark/60 text-brand-text-mid hover:border-brand-accent-light font-semibold"
                data-action="toggle-suspend" data-id="${p.id}">
                ${suspended ? "Reactivate" : "Suspend"}
              </button>
            ` : `
              <button class="px-3 py-2 rounded-lg bg-card-bg border border-brand-accent-dark/60 text-brand-text-mid opacity-60 cursor-not-allowed" disabled>
                Admin
              </button>
            `}

            ${role !== "admin" ? `
              <button class="px-3 py-2 rounded-lg bg-card-bg border border-error-red/60 text-error-red hover:bg-red-900/40 font-semibold col-span-2"
                data-action="delete-student" data-id="${p.id}">
                Delete student
              </button>
            ` : ""}

            ${role === "pending" ? `
              <button class="px-3 py-2 rounded-lg bg-brand-accent-light text-brand-dark-bg font-semibold col-span-2"
                data-action="approve-student" data-id="${p.id}">
                Approve
              </button>
            ` : ""}

            ${role !== "admin"
              ? `<button class="px-3 py-2 rounded-lg bg-card-bg border border-brand-accent-dark/60 text-brand-text-mid hover:border-brand-accent-light font-semibold col-span-2"
                   data-action="make-admin" data-id="${p.id}">
                   Make admin
                 </button>`
              : `<button class="px-3 py-2 rounded-lg bg-card-bg border border-brand-accent-dark/60 text-brand-text-mid hover:border-brand-accent-light font-semibold col-span-2"
                   data-action="make-student" data-id="${p.id}">
                   Make student
                 </button>`
            }
          </div>
        `;
        cards.appendChild(card);
      });
    }

    function applyUserSearch() {
      const term = $("user-search").value.toLowerCase().trim();
      if (!term) {
        filteredProfiles = [...allProfiles];
      } else {
        filteredProfiles = allProfiles.filter((p) => {
          const combo = [
            p.full_name, p.username, p.email, p.phone, p.role, p.instrument, p.status, p.id
          ].filter(Boolean).join(" ").toLowerCase();
          return combo.includes(term);
        });
      }
      renderUsers();
    }

    function sortUsers(mode) {
      filteredProfiles.sort((a, b) => {
        const nameA = (a.full_name || a.username || "").toLowerCase();
        const nameB = (b.full_name || b.username || "").toLowerCase();

        if (mode === "name-asc") return nameA.localeCompare(nameB);
        if (mode === "name-desc") return nameB.localeCompare(nameA);

        if (mode === "next-lesson") {
          const da = a.next_lesson_at ? new Date(a.next_lesson_at).getTime() : Infinity;
          const db = b.next_lesson_at ? new Date(b.next_lesson_at).getTime() : Infinity;
          return da - db;
        }

        if (mode === "role") {
          const rA = (a.role || "student").toLowerCase();
          const rB = (b.role || "student").toLowerCase();
          return rA.localeCompare(rB);
        }

        return 0;
      });

      renderUsers();
    }

    async function updateUserRole(id, role) {
      hideGlobalError();

      if (currentAdminUser?.id === id && role !== "admin") {
        showGlobalError("You can‚Äôt remove your own admin role from here.");
        return;
      }

      const { error } = await supabaseClient
        .from("profiles")
        .update({ role, updated_at: new Date().toISOString() })
        .eq("id", id);

      if (error) {
        console.error(error);
        showGlobalError("Failed to update role. Check RLS on profiles table.");
        return;
      }

      await loadProfiles();
    }

    // ============================
    // EDIT DRAWER
    // ============================
    function openEditDrawer(profile) {
      editProfileId = profile.id;

      $("edit-subtitle").innerHTML = `
        <span class="text-brand-text-mid">ID:</span> <span class="text-brand-text-light">${shortId(profile.id)}</span>
      `;

      $("edit-full-name").value = profile.full_name || "";
      $("edit-instrument").value = profile.instrument || "";
      $("edit-email").value = profile.email || "";
      $("edit-phone").value = profile.phone || "";
      $("edit-status").value = (profile.status || "active");
      $("edit-duration").value = profile.lesson_duration_min ?? "";

      $("edit-next-lesson").value = toDatetimeLocalValue(profile.next_lesson_at);

      $("edit-weekly-enabled").checked = !!profile.weekly_enabled;
      $("edit-weekly-day").value = (profile.weekly_day ?? 1).toString();
      $("edit-weekly-time").value = profile.weekly_time || "";

      $("edit-notes").value = profile.admin_notes || "";

      toggleWeeklyFields();

      $("edit-overlay").classList.remove("hidden");
      $("edit-drawer").classList.remove("hidden");
    }

    function closeEditDrawer() {
      editProfileId = null;
      $("edit-overlay").classList.add("hidden");
      $("edit-drawer").classList.add("hidden");
    }

    function toggleWeeklyFields() {
      const enabled = $("edit-weekly-enabled").checked;
      const box = $("weekly-fields");
      if (enabled) box.classList.remove("hidden");
      else box.classList.add("hidden");
    }

    async function saveEditDrawer() {
      hideGlobalError();
      if (!editProfileId) return;

      const status = $("edit-status").value || "active";
      const isSusp = isSuspendedStatus(status);

      const payload = {
        full_name: $("edit-full-name").value.trim() || null,
        instrument: $("edit-instrument").value.trim() || null,
        email: $("edit-email").value.trim() || null,
        phone: normalizePhone($("edit-phone").value),
        status,
        lesson_duration_min: $("edit-duration").value ? Number($("edit-duration").value) : null,
        next_lesson_at: isSusp ? null : fromDatetimeLocalValue($("edit-next-lesson").value),
        weekly_enabled: isSusp ? false : $("edit-weekly-enabled").checked,
        weekly_day: (isSusp || !$("edit-weekly-enabled").checked) ? null : Number($("edit-weekly-day").value),
        weekly_time: (isSusp || !$("edit-weekly-enabled").checked) ? null : ($("edit-weekly-time").value || null),
        admin_notes: $("edit-notes").value.trim() || null,
        updated_at: new Date().toISOString(),
      };

      const saveBtn = $("edit-save");
      saveBtn.disabled = true;
      saveBtn.classList.add("opacity-60", "cursor-not-allowed");

      try {
        const { error } = await supabaseClient
          .from("profiles")
          .update(payload)
          .eq("id", editProfileId);

        if (error) {
          console.error(error);
          showGlobalError("Failed to save student changes. Check RLS + columns exist on profiles.");
          return;
        }

        closeEditDrawer();
        await loadProfiles();
      } finally {
        saveBtn.disabled = false;
        saveBtn.classList.remove("opacity-60", "cursor-not-allowed");
      }
    }

    function calcNextLessonFromWeekly() {
      const enabled = $("edit-weekly-enabled").checked;
      if (!enabled) {
        showGlobalError("Enable ‚ÄúWeekly recurring‚Äù first.");
        return;
      }

      const day = Number($("edit-weekly-day").value);
      const time = $("edit-weekly-time").value;

      const next = computeNextOccurrence(day, time);
      if (!next) {
        showGlobalError("Please set a valid weekly day + time.");
        return;
      }

      $("edit-next-lesson").value = toDatetimeLocalValue(next.toISOString());
    }

    function clearNextLesson() {
      $("edit-next-lesson").value = "";
    }

    // ============================
    // SCHEDULE TAB
    // ============================
    function getUpcomingProfiles() {
      const students = allProfiles.filter((p) => (p.role || "student") !== "admin");
      const withNext = students
        .filter((p) => p.next_lesson_at)
        .map((p) => ({ ...p, _nextMs: new Date(p.next_lesson_at).getTime() }))
        .filter((p) => Number.isFinite(p._nextMs))
        .sort((a, b) => a._nextMs - b._nextMs);

      if (scheduleMode === "all") return withNext;

      const now = Date.now();
      const limit = now + (14 * 24 * 60 * 60 * 1000);
      return withNext.filter((p) => p._nextMs >= now && p._nextMs <= limit);
    }

    function renderSchedule() {
      const list = $("schedule-list");
      if (!list) return;

      const items = getUpcomingProfiles();
      if (!items.length) {
        list.innerHTML = `
          <div class="px-3 py-3 rounded-lg bg-brand-dark-bg/60 border border-brand-accent-dark/50 text-brand-text-mid text-sm">
            No upcoming lessons found. Add <code>next_lesson_at</code> to a student in the Users tab.
          </div>
        `;
        return;
      }

      list.innerHTML = "";
      items.forEach((p) => {
        const name = p.full_name || p.username || "(no name)";
        const when = formatDate(p.next_lesson_at);

        const weekly = p.weekly_enabled
          ? `<span class="pill-badge bg-brand-accent-light/10 text-brand-accent-light border-brand-accent-light/40">WEEKLY</span>`
          : `<span class="pill-badge bg-card-bg text-brand-text-mid border-brand-accent-dark/40">ONE-OFF</span>`;

        const row = document.createElement("div");
        row.className = "px-3 py-3 rounded-lg bg-brand-dark-bg/60 border border-brand-accent-dark/50 flex flex-col sm:flex-row sm:items-start justify-between gap-3";
        row.innerHTML = `
          <div class="min-w-0">
            <div class="flex items-center gap-2 flex-wrap">
              <div class="font-semibold text-brand-text-light">${safeText(name)}</div>
              ${weekly}
              ${p.instrument ? `<span class="text-[0.7rem] text-brand-text-mid">üéµ ${safeText(p.instrument)}</span>` : ""}
            </div>
            <div class="text-sm text-brand-text-mid mt-1">${safeText(when)}</div>
          </div>

          <div class="flex flex-col sm:items-end gap-2 shrink-0 w-full sm:w-auto">
            <button
              class="w-full sm:w-auto px-3 py-2 rounded-lg bg-brand-accent-light hover:bg-brand-accent-dark text-brand-dark-bg text-xs font-semibold"
              data-action="schedule-edit"
              data-id="${p.id}"
            >
              Edit
            </button>

            <button
              class="w-full sm:w-auto px-3 py-2 rounded-lg bg-card-bg border border-brand-accent-dark/60 text-brand-text-mid hover:border-brand-accent-light text-xs font-semibold"
              data-action="schedule-done"
              data-id="${p.id}"
            >
              Mark done
            </button>
          </div>
        `;
        list.appendChild(row);
      });
    }

    async function markLessonDone(profileId) {
      hideGlobalError();

      const p = allProfiles.find((x) => x.id === profileId);
      if (!p) return;

      let nextISO = null;

      if (p.weekly_enabled && (p.weekly_day !== null && p.weekly_day !== undefined) && p.weekly_time) {
        const next = computeNextOccurrence(Number(p.weekly_day), p.weekly_time);
        if (next) nextISO = next.toISOString();
      }

      const { error } = await supabaseClient
        .from("profiles")
        .update({ next_lesson_at: nextISO, updated_at: new Date().toISOString() })
        .eq("id", profileId);

      if (error) {
        console.error(error);
        showGlobalError("Failed to update next lesson. Check RLS + profiles columns.");
        return;
      }

      await loadProfiles();
    }

    // ============================
    // NEWSLETTERS
    // ============================
    async function initNewsletterEditor() {
      if (quill) return;
      quill = new Quill("#newsletter-editor", {
        theme: "snow",
        placeholder: "Write your newsletter here‚Ä¶",
        modules: {
          toolbar: [
            [{ header: [1, 2, 3, false] }],
            ["bold", "italic", "underline"],
            [{ list: "ordered" }, { list: "bullet" }],
            ["link"],
            ["clean"],
          ],
        },
      });

      quill.on("text-change", updateNewsletterPreview);
      $("newsletter-title").addEventListener("input", updateNewsletterPreview);
      updateNewsletterPreview();
    }

    function updateNewsletterPreview() {
      const title = $("newsletter-title").value.trim();
      const html = (quill?.root?.innerHTML || "").trim();
      $("newsletter-preview-title").textContent = title || "(Title will appear here)";
      $("newsletter-preview-body").innerHTML = html || "Start typing in the editor to see a preview...";
    }

    async function loadNewsletters() {
      hideGlobalError();
      const listEl = $("newsletter-list");
      listEl.innerHTML = `<p class="text-brand-text-mid text-sm">Loading newsletters‚Ä¶</p>`;

      const { data, error } = await supabaseClient
        .from("newsletters")
        .select("*")
        .order("created_at", { ascending: false });

      if (error) {
        console.error(error);
        listEl.innerHTML = `<p class="text-error-red text-sm">Could not load newsletters. Check RLS.</p>`;
        return;
      }

      $("stat-newsletters").textContent = (data?.length || 0).toString();

      if (!data?.length) {
        listEl.innerHTML = `<p class="text-brand-text-mid text-sm">No newsletters yet.</p>`;
        return;
      }

      listEl.innerHTML = "";

      data.forEach((n) => {
        const row = document.createElement("div");
        row.className =
          "newsletter-item w-full text-left px-3 py-2 rounded-lg bg-brand-dark-bg/70 border border-brand-accent-dark/50 hover:border-brand-accent-light transition cursor-pointer";
        row.dataset.id = n.id;

        const statusBadge = n.published
          ? `<span class="pill-badge bg-brand-accent-light/15 text-brand-accent-light border-brand-accent-light/40 ml-2">PUBLISHED</span>`
          : `<span class="pill-badge bg-yellow-500/10 text-yellow-300 border-yellow-500/40 ml-2">DRAFT</span>`;

        row.innerHTML = `
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <div class="font-semibold text-brand-text-light flex flex-wrap items-center gap-2">
                <span class="truncate">${safeText(n.title || "(Untitled)")}</span>
                ${statusBadge}
              </div>
              <div class="text-[0.7rem] text-brand-text-mid mt-0.5">
                ${formatDate(n.created_at)}
              </div>
            </div>

            <div class="flex flex-col items-end gap-1 text-[0.7rem] shrink-0">
              <button
                type="button"
                class="px-2 py-1 rounded-md bg-card-bg border border-brand-accent-dark/60 text-brand-text-mid hover:border-brand-accent-light"
                data-action="toggle-publish"
                data-id="${n.id}"
              >
                ${n.published ? "Unpublish" : "Publish"}
              </button>
              <button
                type="button"
                class="px-2 py-1 rounded-md bg-card-bg border border-error-red/60 text-error-red hover:bg-red-900/40"
                data-action="delete-newsletter"
                data-id="${n.id}"
              >
                Delete
              </button>
            </div>
          </div>
        `;
        listEl.appendChild(row);
      });
    }

    function setNewsletterButtonsDisabled(disabled) {
      ["newsletter-save-draft", "newsletter-publish", "newsletter-clear"].forEach((id) => {
        const el = $(id);
        if (!el) return;
        el.disabled = disabled;
        el.classList.toggle("opacity-60", disabled);
        el.classList.toggle("cursor-not-allowed", disabled);
      });
    }

    async function saveNewsletter(published) {
      hideGlobalError();

      const title = $("newsletter-title").value.trim();
      const html = (quill?.root?.innerHTML || "").trim();

      if (!title && !html) {
        showGlobalError("Cannot save an empty newsletter.");
        return;
      }

      const payload = {
        title: title || "(Untitled)",
        content_html: html || "",
        published: !!published,
        updated_at: new Date().toISOString(),
      };

      setNewsletterButtonsDisabled(true);

      let savedRow = null;

      try {
        if (currentNewsletterId) {
          const { data, error } = await supabaseClient
            .from("newsletters")
            .update(payload)
            .eq("id", currentNewsletterId)
            .select()
            .single();

          if (error) throw error;
          savedRow = data;
        } else {
          const { data, error } = await supabaseClient
            .from("newsletters")
            .insert(payload)
            .select()
            .single();

          if (error) throw error;
          savedRow = data;
          currentNewsletterId = data.id;
        }

        if (published && savedRow?.id) {
          try {
            await supabaseClient.functions.invoke("newsletter-notify", {
              body: {
                newsletter_id: savedRow.id,
                title: savedRow.title,
                content_html: savedRow.content_html,
              },
            });
          } catch (fnErr) {
            console.warn("newsletter-notify function failed or not deployed yet:", fnErr);
          }
        }

        await loadNewsletters();
      } catch (err) {
        console.error(err);
        showGlobalError("Failed to save newsletter. Check RLS + table columns.");
      } finally {
        setNewsletterButtonsDisabled(false);
      }
    }

    function clearNewsletterEditor() {
      currentNewsletterId = null;
      $("newsletter-title").value = "";
      if (quill) quill.setContents([]);
      updateNewsletterPreview();
    }

    async function toggleNewsletterPublish(id) {
      hideGlobalError();

      const { data, error } = await supabaseClient
        .from("newsletters")
        .select("id, published, title, content_html")
        .eq("id", id)
        .single();

      if (error || !data) {
        showGlobalError("Could not toggle publish state ‚Äî row not found.");
        return;
      }

      const newState = !data.published;

      const { error: updateError } = await supabaseClient
        .from("newsletters")
        .update({ published: newState, updated_at: new Date().toISOString() })
        .eq("id", id);

      if (updateError) {
        console.error(updateError);
        showGlobalError("Failed to update publish state.");
        return;
      }

      if (newState) {
        try {
          await supabaseClient.functions.invoke("newsletter-notify", {
            body: {
              newsletter_id: data.id,
              title: data.title,
              content_html: data.content_html,
            },
          });
        } catch (err) {
          console.warn("newsletter-notify function failed or not deployed yet:", err);
        }
      }

      await loadNewsletters();
    }

    async function deleteNewsletter(id) {
      hideGlobalError();
      if (!confirm("Delete this newsletter permanently?")) return;

      const { error } = await supabaseClient
        .from("newsletters")
        .delete()
        .eq("id", id);

      if (error) {
        console.error(error);
        showGlobalError("Failed to delete newsletter.");
        return;
      }

      if (currentNewsletterId === id) {
        clearNewsletterEditor();
      }

      await loadNewsletters();
    }

    async function loadNewsletterIntoEditor(id) {
      hideGlobalError();

      const { data, error } = await supabaseClient
        .from("newsletters")
        .select("*")
        .eq("id", id)
        .single();

      if (error || !data) {
        console.error(error);
        showGlobalError("Could not load that newsletter.");
        return;
      }

      currentNewsletterId = data.id;
      $("newsletter-title").value = data.title || "";

      if (quill) {
        quill.setContents([]);
        quill.clipboard.dangerouslyPasteHTML(data.content_html || "");
      }

      updateNewsletterPreview();
    }

    function handleNewsletterListClick(event) {
      const actionBtn = event.target.closest("button[data-action]");
      if (actionBtn) {
        const action = actionBtn.dataset.action;
        const nId = actionBtn.dataset.id;
        if (action === "toggle-publish") toggleNewsletterPublish(nId);
        if (action === "delete-newsletter") deleteNewsletter(nId);
        return;
      }

      const item = event.target.closest(".newsletter-item");
      if (!item) return;

      const id = item.dataset.id;
      if (id) loadNewsletterIntoEditor(id);
    }

    // ============================
    // FILES (Storage: student_files)
    // ============================
    function populateStudentSelect() {
      const select = $("files-student-select");
      if (!select) return;

      const previous = select.value;
      select.innerHTML = `<option value="">Select a student...</option>`;

      const students = allProfiles.filter((p) => (p.role || "student") !== "admin");

      students.forEach((p) => {
        const opt = document.createElement("option");
        opt.value = p.id;
        const name = p.full_name || p.username || "(no name)";
        opt.textContent = `${name} ‚Äî ${shortId(p.id)}`;
        select.appendChild(opt);
      });

      if (students.some((p) => p.id === previous)) select.value = previous;
    }

    async function loadFilesForStudent(studentId) {
      const listEl = $("file-list");

      if (!studentId) {
        listEl.innerHTML = '<p class="text-brand-text-mid text-sm">Select a student above to view their attached files.</p>';
        return;
      }

      listEl.innerHTML = '<p class="text-brand-text-mid text-sm">Loading files‚Ä¶</p>';

      try {
        const { data, error } = await supabaseClient.storage
          .from(STUDENT_FILES_BUCKET)
          .list(studentId + "/", { limit: 100, offset: 0, sortBy: { column: "name", order: "asc" } });

        if (error) {
          console.error(error);
          const msg = (error?.message || "").toLowerCase().includes("bucket not found")
            ? `Bucket not found: "${STUDENT_FILES_BUCKET}". Check Supabase Storage bucket name matches this constant.`
            : "Could not list files. Check bucket + storage policies.";
          listEl.innerHTML = `<p class="text-error-red text-sm">${msg}</p>`;
          return;
        }

        if (!data?.length) {
          listEl.innerHTML = '<p class="text-brand-text-mid text-sm">No files uploaded yet for this student.</p>';
          return;
        }

        listEl.innerHTML = "";

        const rows = await Promise.all(
          data.map(async (file) => {
            const fullPath = `${studentId}/${file.name}`;

            let url = "#";
            const signed = await supabaseClient.storage.from(STUDENT_FILES_BUCKET).createSignedUrl(fullPath, 60 * 60);
            if (!signed.error && signed.data?.signedUrl) {
              url = signed.data.signedUrl;
            } else {
              const { data: pub } = supabaseClient.storage.from(STUDENT_FILES_BUCKET).getPublicUrl(fullPath);
              url = pub?.publicUrl || "#";
            }

            const row = document.createElement("div");
            row.className =
              "flex flex-col sm:flex-row sm:items-center justify-between gap-3 px-3 py-2 rounded-lg bg-brand-dark-bg/70 border border-brand-accent-dark/60";
            row.innerHTML = `
              <div class="text-[0.95rem] sm:text-xs min-w-0">
                <div class="font-semibold text-brand-text-light break-all">${safeText(file.name)}</div>
              </div>
              <div class="flex flex-col sm:flex-row sm:items-center gap-2 text-[0.8rem] sm:text-[0.7rem] shrink-0 w-full sm:w-auto">
                <a href="${url}" target="_blank" rel="noreferrer"
                   class="w-full sm:w-auto text-center px-2 py-2 sm:py-1 rounded-md bg-card-bg border border-brand-accent-dark/60 text-brand-text-mid hover:border-brand-accent-light">
                  View / Download
                </a>
                <button type="button"
                  class="w-full sm:w-auto px-2 py-2 sm:py-1 rounded-md bg-card-bg border border-error-red/60 text-error-red hover:bg-red-900/40"
                  data-file="${file.name}" data-student="${studentId}">
                  Delete
                </button>
              </div>
            `;
            return row;
          })
        );

        rows.forEach((r) => listEl.appendChild(r));
      } catch (err) {
        console.error(err);
        listEl.innerHTML = '<p class="text-error-red text-sm">Unexpected error while loading files.</p>';
      }
    }

    async function uploadFileForStudent() {
      hideGlobalError();

      const studentId = $("files-student-select").value;
      const input = $("file-input");
      const file = input.files?.[0];

      if (!studentId) return showGlobalError("Please choose a student before uploading.");
      if (!file) return showGlobalError("Please select a file to upload.");

      const safeName = file.name.replace(/[^\w.\-() ]+/g, "_");
      const path = `${studentId}/${Date.now()}-${safeName}`;

      const { error } = await supabaseClient.storage.from(STUDENT_FILES_BUCKET).upload(path, file, { upsert: false });

      if (error) {
        console.error(error);
        const msg = (error?.message || "").toLowerCase().includes("bucket not found")
          ? `Bucket not found: "${STUDENT_FILES_BUCKET}". Check Supabase Storage bucket name matches this constant.`
          : "File upload failed. Check storage policies and bucket name.";
        showGlobalError(msg);
        return;
      }

      input.value = "";
      await loadFilesForStudent(studentId);
    }

    async function deleteFile(studentId, fileName) {
      hideGlobalError();
      if (!confirm("Delete this file for this student?")) return;

      const fullPath = `${studentId}/${fileName}`;
      const { error } = await supabaseClient.storage.from(STUDENT_FILES_BUCKET).remove([fullPath]);

      if (error) {
        console.error(error);
        showGlobalError("Failed to delete file from storage.");
        return;
      }

      await loadFilesForStudent(studentId);
    }

    // ============================
    // TABS
    // ============================
    function switchTab(tabName) {
      const sections = {
        users: $("tab-users"),
        schedule: $("tab-schedule"),
        newsletters: $("tab-newsletters"),
        files: $("tab-files"),
      };

      Object.entries(sections).forEach(([key, el]) => {
        if (!el) return;
        if (key === tabName) el.classList.remove("hidden");
        else el.classList.add("hidden");
      });

      document.querySelectorAll(".tab-btn").forEach((btn) => {
        const name = btn.getAttribute("data-tab");
        if (name === tabName) {
          btn.classList.remove("tab-inactive");
          btn.classList.add("tab-active");
        } else {
          btn.classList.remove("tab-active");
          btn.classList.add("tab-inactive");
        }
      });
    }

    // ============================
    // INIT
    // ============================
    document.addEventListener("DOMContentLoaded", async () => {
      // Session check first
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) {
        safeRedirect("login.html");
        return;
      }

      // Redirect ONLY on real sign-out events
      supabaseClient.auth.onAuthStateChange((event) => {
        if (event === "SIGNED_OUT" || event === "USER_DELETED" || event === "TOKEN_REFRESH_FAILED") {
          safeRedirect("login.html");
        }
      });

      // Logout
      $("logout-button").addEventListener("click", async () => {
        await supabaseClient.auth.signOut();
        safeRedirect("login.html");
      });

      // Enforce admin
      const ok = await ensureAdmin();
      if (!ok) return;

      // Tabs
      document.querySelectorAll(".tab-btn").forEach((btn) => {
        btn.addEventListener("click", () => switchTab(btn.getAttribute("data-tab")));
      });

      // Users: search + sort + row actions (‚úÖ now listens on cards + table)
      $("user-search").addEventListener("input", applyUserSearch);
      document.querySelectorAll(".user-sort").forEach((btn) => {
        btn.addEventListener("click", () => sortUsers(btn.getAttribute("data-sort")));
      });

      $("users-actions").addEventListener("click", (event) => {
        const btn = event.target.closest("button[data-action]");
        if (!btn) return;

        const action = btn.dataset.action;
        const id = btn.dataset.id;
        if (!id) return;

        if (action === "approve-student") updateUserRole(id, "student");
        if (action === "make-admin") updateUserRole(id, "admin");
        if (action === "make-student") updateUserRole(id, "student");

        if (action === "edit") {
          const p = allProfiles.find((x) => x.id === id);
          if (p) openEditDrawer(p);
        }

        if (action === "toggle-suspend") {
          const p = allProfiles.find((x) => x.id === id);
          const suspended = isSuspendedStatus(p?.status);
          setStudentStatus(id, suspended ? "active" : "paused");
        }

        if (action === "delete-student") {
          deleteStudent(id);
        }
      });

      // Drawer controls
      $("edit-overlay").addEventListener("click", closeEditDrawer);
      $("edit-close").addEventListener("click", closeEditDrawer);
      $("edit-cancel").addEventListener("click", closeEditDrawer);
      $("edit-save").addEventListener("click", saveEditDrawer);

      $("edit-weekly-enabled").addEventListener("change", toggleWeeklyFields);
      $("edit-calc-next").addEventListener("click", calcNextLessonFromWeekly);
      $("edit-clear-next").addEventListener("click", clearNextLesson);

      // Schedule actions
      $("schedule-refresh").addEventListener("click", () => renderSchedule());
      $("schedule-show-all").addEventListener("click", () => { scheduleMode = "all"; renderSchedule(); });
      $("schedule-next-14").addEventListener("click", () => { scheduleMode = "14"; renderSchedule(); });

      $("schedule-list").addEventListener("click", (event) => {
        const btn = event.target.closest("button[data-action]");
        if (!btn) return;
        const action = btn.dataset.action;
        const id = btn.dataset.id;

        if (action === "schedule-edit") {
          const p = allProfiles.find((x) => x.id === id);
          if (p) openEditDrawer(p);
        }

        if (action === "schedule-done") {
          markLessonDone(id);
        }
      });

      // Load base data
      await loadProfiles();

      // Newsletters
      await initNewsletterEditor();
      await loadNewsletters();

      $("newsletter-save-draft").addEventListener("click", () => saveNewsletter(false));
      $("newsletter-publish").addEventListener("click", () => saveNewsletter(true));
      $("newsletter-clear").addEventListener("click", clearNewsletterEditor);
      $("newsletter-refresh").addEventListener("click", loadNewsletters);
      $("newsletter-list").addEventListener("click", handleNewsletterListClick);

      // Files
      $("files-student-select").addEventListener("change", (e) => loadFilesForStudent(e.target.value));
      $("upload-file-button").addEventListener("click", uploadFileForStudent);
      $("file-list").addEventListener("click", (event) => {
        const btn = event.target.closest("button[data-file][data-student]");
        if (!btn) return;
        deleteFile(btn.dataset.student, btn.dataset.file);
      });

      // Default tab
      switchTab("users");
    });
  </script>
</body>
</html>
