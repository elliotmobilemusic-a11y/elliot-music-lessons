<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin ‚Äì Elliot's Mobile Music Lessons</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="/favicon.png" type="image/png" />

  <!-- Tailwind CDN (fine for now while developing) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'brand-dark-bg': '#1a1a2e',
            'brand-accent-light': '#00d084',
            'brand-accent-dark': '#00a36e',
            'brand-text-light': '#e0e0e0',
            'brand-text-mid': '#a0a0a0',
            'brand-highlight': '#ffb703',
            'card-bg': '#252538',
            'error-red': '#f87171',
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
            heading: ['Montserrat', 'sans-serif'],
          },
        }
      }
    }
  </script>

  <!-- Fonts + Quill CSS -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Montserrat:wght@700;800;900&display=swap');

    body {
      font-family: 'Inter', sans-serif;
      background-color: #1a1a2e;
      color: #e0e0e0;
      background-image: radial-gradient(circle at 100% 100%, #252538 0%, #1a1a2e 70%);
    }

    .card-glow {
      box-shadow: 0 0 30px rgba(0, 208, 132, 0.15);
    }

    .tab-active {
      border-color: #00d084;
      background-color: rgba(0, 208, 132, 0.1);
      color: #e0e0e0;
    }

    .tab-inactive {
      border-color: rgba(160, 160, 190, 0.3);
      background-color: transparent;
      color: #a0a0a0;
    }

    .pill-badge {
      border-radius: 999px;
      padding: 0.1rem 0.6rem;
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 700;
    }

    /* Quill styling */
    .ql-toolbar.ql-snow {
      border-radius: 0.75rem 0.75rem 0 0;
      border: 1px solid #3b3b5a;
      background: #1a1a2e;
      color: #e0e0e0;
    }
    .ql-container.ql-snow {
      border-radius: 0 0 0.75rem 0.75rem;
      border: 1px solid #3b3b5a;
      background: #1a1a2e;
      color: #e0e0e0;
      min-height: 180px;
    }
    .ql-editor {
      min-height: 180px;
    }

    /* Scrollbars */
    .scroll-skinny::-webkit-scrollbar {
      width: 6px;
    }
    .scroll-skinny::-webkit-scrollbar-track {
      background: rgba(37, 37, 56, 0.8);
    }
    .scroll-skinny::-webkit-scrollbar-thumb {
      background: rgba(0, 208, 132, 0.6);
      border-radius: 999px;
    }
  </style>

  <!-- Quill JS -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" />
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

  <!-- Supabase JS (UMD, same pattern as login.html) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="min-h-screen flex flex-col">

  <!-- NAVIGATION -->
  <nav class="bg-brand-dark-bg/90 backdrop-blur border-b border-brand-accent-dark/40 text-white sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <!-- Logo -->
        <a href="index.html" class="flex items-center space-x-2">
          <span class="inline-flex items-center justify-center w-9 h-9 rounded-full bg-brand-accent-light/10 border border-brand-accent-light/50">
            <svg xmlns="http://www.w3.org/2000/svg"
              width="24" height="24" viewBox="0 0 24 24"
              fill="none" stroke="currentColor"
              stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round"
              class="w-5 h-5 text-brand-accent-light">
              <circle cx="8" cy="18" r="4"></circle>
              <path d="M12 18V2l7 4"></path>
            </svg>
          </span>
          <span class="text-xs sm:text-sm font-heading font-extrabold tracking-[0.18em] text-brand-highlight">
            ELLIOT'S MOBILE MUSIC ‚Äì ADMIN
          </span>
        </a>

        <!-- Right: admin pill + logout -->
        <div class="flex items-center space-x-3 text-xs sm:text-sm">
          <span
            id="admin-user-pill"
            class="hidden sm:inline-flex items-center gap-2 px-3 py-1 rounded-full bg-card-bg border border-brand-accent-dark/60 text-brand-text-mid"
          >
            <span class="w-2 h-2 rounded-full bg-brand-accent-light"></span>
            <span>Logged in‚Ä¶</span>
          </span>

          <button
            id="logout-button"
            class="px-3 py-1 rounded-lg bg-card-bg border border-brand-accent-dark/50 text-brand-text-mid hover:bg-brand-accent-dark hover:text-brand-dark-bg text-xs font-semibold transition"
          >
            Log out
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- MAIN -->
  <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-10 flex-grow">
    <!-- Global Error Banner -->
    <div id="global-error" class="hidden mb-4 p-3 rounded-lg bg-red-900/40 border border-error-red text-error-red text-sm"></div>

    <!-- Header + stats -->
    <header class="mb-6 sm:mb-8">
      <p class="text-[0.7rem] tracking-[0.22em] font-semibold text-brand-highlight uppercase mb-2">
        Internal Control Panel
      </p>
      <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-4">
        <div>
          <h1 class="font-heading text-3xl sm:text-4xl font-extrabold text-brand-text-light">
            Admin Dashboard
          </h1>
          <p class="text-sm sm:text-base text-brand-text-mid mt-1 max-w-xl">
            Manage students, newsletters, and shared resources from one place.
          </p>
        </div>
        <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 text-xs">
          <div class="bg-card-bg/90 border border-brand-accent-dark/50 rounded-lg px-3 py-2 text-center">
            <p class="text-brand-text-mid">Total Profiles</p>
            <p id="stat-total-users" class="text-lg font-bold text-brand-accent-light">‚Äì</p>
          </div>
          <div class="bg-card-bg/90 border border-brand-accent-dark/50 rounded-lg px-3 py-2 text-center">
            <p class="text-brand-text-mid">Admins</p>
            <p id="stat-admins" class="text-lg font-bold text-brand-highlight">‚Äì</p>
          </div>
          <div class="bg-card-bg/90 border border-brand-accent-dark/50 rounded-lg px-3 py-2 text-center">
            <p class="text-brand-text-mid">Newsletters</p>
            <p id="stat-newsletters" class="text-lg font-bold text-brand-accent-light">‚Äì</p>
          </div>
        </div>
      </div>
    </header>

    <!-- Tabs -->
    <div class="mb-6 flex flex-wrap gap-2">
      <button
        class="tab-btn tab-active px-4 py-2 rounded-full border text-xs sm:text-sm font-semibold"
        data-tab="users"
      >
        üë§ Students & Profiles
      </button>
      <button
        class="tab-btn tab-inactive px-4 py-2 rounded-full border text-xs sm:text-sm font-semibold"
        data-tab="newsletters"
      >
        üì∞ Newsletters
      </button>
      <button
        class="tab-btn tab-inactive px-4 py-2 rounded-full border text-xs sm:text-sm font-semibold"
        data-tab="files"
      >
        üìÅ Files per Student
      </button>
    </div>

    <!-- TAB: USERS -->
    <section id="tab-users" class="space-y-4">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div class="flex-1">
          <label class="block text-xs font-semibold text-brand-text-mid mb-1">
            Search students/admins
          </label>
          <input
            id="user-search"
            type="text"
            placeholder="Name, email, role, id..."
            class="w-full px-3 py-2 rounded-lg bg-brand-dark-bg border border-brand-accent-dark/50 text-sm focus:outline-none focus:border-brand-accent-light focus:ring-2 focus:ring-brand-accent-light/40"
          />
        </div>
        <div class="flex flex-wrap gap-2 text-xs">
          <button class="user-sort px-3 py-2 rounded-lg bg-card-bg border border-brand-accent-dark/40 hover:border-brand-accent-light" data-sort="name-asc">
            A‚ÄìZ
          </button>
          <button class="user-sort px-3 py-2 rounded-lg bg-card-bg border border-brand-accent-dark/40 hover:border-brand-accent-light" data-sort="name-desc">
            Z‚ÄìA
          </button>
          <button class="user-sort px-3 py-2 rounded-lg bg-card-bg border border-brand-accent-dark/40 hover:border-brand-accent-light" data-sort="role">
            By Role
          </button>
        </div>
      </div>

      <div class="bg-card-bg/90 border border-brand-accent-dark/60 rounded-xl card-glow overflow-hidden">
        <div class="px-4 py-3 border-b border-brand-accent-dark/50 flex justify-between items-center text-xs">
          <span class="text-brand-text-mid">
            Profiles are synced from Supabase <span class="hidden sm:inline">(`profiles` table)</span>.
          </span>
          <span class="pill-badge bg-brand-accent-light/10 text-brand-accent-light border border-brand-accent-light/40">
            ROLE: student / admin / pending
          </span>
        </div>

        <div class="max-h-[420px] overflow-y-auto scroll-skinny">
          <table class="min-w-full text-xs sm:text-sm">
            <thead class="bg-brand-dark-bg/70 sticky top-0 z-10">
              <tr>
                <th class="px-4 py-3 text-left font-semibold text-brand-text-mid">Name / Email</th>
                <th class="px-4 py-3 text-left font-semibold text-brand-text-mid">Role</th>
                <th class="px-4 py-3 text-left font-semibold text-brand-text-mid">ID (short)</th>
                <th class="px-4 py-3 text-right font-semibold text-brand-text-mid">Actions</th>
              </tr>
            </thead>
            <tbody id="users-table-body" class="divide-y divide-[#333355]">
              <!-- JS fills -->
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- TAB: NEWSLETTERS -->
    <section id="tab-newsletters" class="hidden space-y-4">
      <div class="grid grid-cols-1 lg:grid-cols-[1.5fr_minmax(0,1.1fr)] gap-5">
        <!-- Editor -->
        <div class="bg-card-bg/90 border border-brand-accent-dark/60 rounded-xl card-glow p-4 sm:p-5">
          <div class="flex items-center justify-between mb-3 gap-3">
            <div>
              <h2 class="font-heading text-xl font-bold text-brand-text-light">
                Newsletter Editor
              </h2>
              <p class="text-xs text-brand-text-mid">
                Write updates that will appear on student portals.
              </p>
            </div>
            <span class="pill-badge bg-brand-accent-light/10 text-brand-accent-light border border-brand-accent-light/40">
              DRAFT / PUBLISH
            </span>
          </div>

          <div class="mb-3">
            <label class="text-xs font-semibold text-brand-text-mid mb-1 block">
              Title
            </label>
            <input
              id="newsletter-title"
              type="text"
              placeholder="e.g. January Piano Progress & Holiday Updates"
              class="w-full px-3 py-2 rounded-lg bg-brand-dark-bg border border-brand-accent-dark/50 text-sm focus:outline-none focus:border-brand-accent-light focus:ring-2 focus:ring-brand-accent-light/40"
            />
          </div>

          <div class="mb-3">
            <label class="text-xs font-semibold text-brand-text-mid mb-1 block">
              Content
            </label>
            <div id="newsletter-editor"></div>
          </div>

          <div class="flex flex-wrap gap-2 mt-3 text-xs">
            <button
              id="newsletter-save-draft"
              class="px-4 py-2 rounded-lg bg-card-bg border border-brand-accent-dark/60 hover:border-brand-accent-light text-brand-text-mid font-semibold"
            >
              üíæ Save Draft
            </button>
            <button
              id="newsletter-publish"
              class="px-4 py-2 rounded-lg bg-brand-accent-light hover:bg-brand-accent-dark text-brand-dark-bg font-semibold"
            >
              üöÄ Publish & Notify
            </button>
            <button
              id="newsletter-clear"
              class="px-3 py-2 rounded-lg bg-card-bg border border-brand-accent-dark/60 text-brand-text-mid hover:text-error-red hover:border-error-red"
            >
              Clear
            </button>
          </div>

          <p class="mt-3 text-[0.7rem] text-brand-text-mid">
            Drafts are saved to the <code>newsletters</code> table. Published entries can be shown on the student portal homepage.
          </p>
        </div>

        <!-- List + preview -->
        <div class="space-y-4">
          <div class="bg-card-bg/90 border border-brand-accent-dark/60 rounded-xl card-glow p-4 sm:p-5">
            <div class="flex items-center justify-between mb-3">
              <h3 class="font-heading text-lg font-bold text-brand-text-light">
                Previous Newsletters
              </h3>
              <button
                id="newsletter-refresh"
                class="text-xs px-3 py-1 rounded-lg bg-card-bg border border-brand-accent-dark/60 text-brand-text-mid hover:border-brand-accent-light"
              >
                Refresh
              </button>
            </div>
            <div id="newsletter-list" class="space-y-2 max-h-56 overflow-y-auto scroll-skinny text-xs sm:text-sm">
              <!-- JS fills -->
            </div>
          </div>

          <div class="bg-card-bg/90 border border-brand-accent-dark/60 rounded-xl card-glow p-4 sm:p-5">
            <h3 class="font-heading text-lg font-bold text-brand-text-light mb-2">
              Live Preview
            </h3>
            <h4 id="newsletter-preview-title" class="text-sm font-semibold text-brand-highlight mb-1">
              (Title will appear here)
            </h4>
            <div
              id="newsletter-preview-body"
              class="prose prose-invert max-w-none text-xs sm:text-sm text-brand-text-mid"
            >
              Start typing in the editor to see a preview...
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- TAB: FILES -->
    <section id="tab-files" class="hidden space-y-4">
      <div class="bg-card-bg/90 border border-brand-accent-dark/60 rounded-xl card-glow p-4 sm:p-5">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
          <div>
            <h2 class="font-heading text-xl font-bold text-brand-text-light">
              Upload Files for a Student
            </h2>
            <p class="text-xs sm:text-sm text-brand-text-mid">
              Use this for sheet music, lesson plans, PDFs or backing tracks tied to a specific student.
            </p>
          </div>
          <span class="pill-badge bg-brand-accent-light/10 text-brand-accent-light border border-brand-accent-light/40">
            Storage: student_files
          </span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-[1.2fr_minmax(0,1fr)] gap-4">
          <div>
            <label class="block text-xs font-semibold text-brand-text-mid mb-1">
              Choose student profile
            </label>
            <select
              id="files-student-select"
              class="w-full px-3 py-2 rounded-lg bg-brand-dark-bg border border-brand-accent-dark/50 text-sm focus:outline-none focus:border-brand-accent-light focus:ring-2 focus:ring-brand-accent-light/40"
            >
              <option value="">Select a student...</option>
            </select>
            <p class="text-[0.7rem] text-brand-text-mid mt-1">
              List is based on entries in the <code>profiles</code> table.
            </p>
          </div>
          <div>
            <label class="block text-xs font-semibold text-brand-text-mid mb-1">
              File
            </label>
            <input
              id="file-input"
              type="file"
              class="block w-full text-xs text-brand-text-mid file:mr-3 file:py-2 file:px-3 file:rounded-lg file:border-0 file:bg-brand-accent-light file:text-brand-dark-bg hover:file:bg-brand-accent-dark"
            />
            <p class="text-[0.7rem] text-brand-text-mid mt-1">
              Uploaded to <code>student_files/{student_id}/</code>.
            </p>
          </div>
        </div>

        <div class="mt-4">
          <button
            id="upload-file-button"
            class="px-4 py-2 rounded-lg bg-brand-accent-light hover:bg-brand-accent-dark text-brand-dark-bg text-sm font-semibold"
          >
            ‚¨Ü Upload File for Student
          </button>
        </div>
      </div>

      <div class="bg-card-bg/90 border border-brand-accent-dark/60 rounded-xl card-glow p-4 sm:p-5">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-heading text-lg font-bold text-brand-text-light">
            Files for Selected Student
          </h3>
          <span class="text-[0.7rem] text-brand-text-mid">
            Only files for the chosen student are shown.
          </span>
        </div>
        <div id="file-list" class="space-y-2 max-h-72 overflow-y-auto scroll-skinny text-xs sm:text-sm">
          <p class="text-brand-text-mid text-sm">
            Select a student above to view their attached files.
          </p>
        </div>
      </div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="bg-gray-900 text-brand-text-mid py-6 mt-8 flex-shrink-0">
    <div class="max-w-6xl mx-auto px-4 text-center text-xs sm:text-sm">
      <p>&copy; 2024 Elliot Wardill Mobile Music Lessons. All rights reserved.</p>
      <p class="mt-2 text-gray-500">
        Internal admin area ‚Äî not visible to parents or students.
      </p>
    </div>
  </footer>

  <!-- ADMIN LOGIC -->
  <script>
    // üîê Supabase config ‚Äì SAME as working login.html
    const SUPABASE_URL = "https://gorrhpliwhpznmdqhzjo.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdvcnJocGxpd2hwem5tZHFoempvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxMzAxMzYsImV4cCI6MjA4MDcwNjEzNn0.lqQGk_KT4kQQyqGJA-P8nZr1ksE5NOQvzpvYPD1JYGM";

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Global state
    let currentAdminUser = null;
    let currentAdminProfile = null;
    let allProfiles = [];
    let filteredProfiles = [];
    let quill = null;
    let currentNewsletterId = null;

    const $ = (id) => document.getElementById(id);

    function showGlobalError(message) {
      const box = $("global-error");
      box.textContent = message;
      box.classList.remove("hidden");
    }

    function hideGlobalError() {
      const box = $("global-error");
      box.classList.add("hidden");
      box.textContent = "";
    }

    function formatDate(value) {
      if (!value) return "‚Äì";
      const d = new Date(value);
      if (isNaN(d.getTime())) return "‚Äì";
      return d.toLocaleString("en-GB", {
        year: "numeric",
        month: "short",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
      });
    }

    function shortId(id) {
      if (!id) return "‚Äì";
      return id.slice(0, 8) + "‚Ä¶";
    }

    // 1) AUTH + ADMIN CHECK
    async function ensureAdmin() {
      const { data, error } = await supabaseClient.auth.getUser();
      if (error || !data || !data.user) {
        window.location.href = "login.html";
        return;
      }

      currentAdminUser = data.user;

      const { data: profile, error: profileError } = await supabaseClient
        .from("profiles")
        .select("*")
        .eq("id", currentAdminUser.id)
        .single();

      if (profileError || !profile) {
        showGlobalError("Your profile could not be loaded. Make sure a row exists in the profiles table.");
        return;
      }

      currentAdminProfile = profile;

      if (profile.role !== "admin") {
        // Logged in but no admin role ‚Üí student portal
        window.location.href = "portal.html";
        return;
      }

      const pill = $("admin-user-pill");
      if (pill) {
        const name = profile.full_name || profile.username || currentAdminUser.email || "Admin user";
        pill.innerHTML = `
          <span class="w-2 h-2 rounded-full bg-brand-accent-light"></span>
          <span>${name}</span>
          <span class="pill-badge bg-brand-accent-light/10 text-brand-accent-light border border-brand-accent-light/40 ml-2">ADMIN</span>
        `;
        pill.classList.remove("hidden");
      }
    }

    // 2) USERS
    async function loadProfiles() {
      hideGlobalError();
      const { data, error } = await supabaseClient
        .from("profiles")
        .select("*");

      if (error) {
        console.error(error);
        showGlobalError("Could not load profiles from Supabase. Check the profiles table and RLS policies.");
        return;
      }

      allProfiles = Array.isArray(data) ? data : [];
      filteredProfiles = [...allProfiles];
      renderUsersTable();
      updateUserStats();
      populateStudentSelect();
    }

    function updateUserStats() {
      $("stat-total-users").textContent = allProfiles.length.toString();
      const admins = allProfiles.filter((p) => p.role === "admin").length;
      $("stat-admins").textContent = admins.toString();
    }

    function renderUsersTable() {
      const tbody = $("users-table-body");
      tbody.innerHTML = "";

      if (!filteredProfiles.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" class="px-4 py-4 text-center text-brand-text-mid text-sm">
              No profiles found yet. Students appear here once an account/profile is created.
            </td>
          </tr>
        `;
        return;
      }

      filteredProfiles.forEach((p) => {
        const displayName = p.full_name || p.username || "(no name set)";
        const email = p.email || "";
        const role = p.role || "student";
        const created = formatDate(p.created_at || p.updated_at);

        let roleColor = "bg-brand-accent-light/10 text-brand-accent-light border-brand-accent-light/40";
        if (role === "admin") roleColor = "bg-brand-highlight/15 text-brand-highlight border-brand-highlight/60";
        if (role === "pending") roleColor = "bg-yellow-500/10 text-yellow-300 border-yellow-500/50";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-4 py-3 align-top">
            <div class="font-semibold text-brand-text-light">${displayName}</div>
            ${email ? `<div class="text-[0.7rem] text-brand-text-mid mt-0.5">${email}</div>` : ""}
            <div class="text-[0.7rem] text-brand-text-mid mt-0.5">${created}</div>
          </td>
          <td class="px-4 py-3 align-top">
            <span class="pill-badge border ${roleColor}">
              ${role.toUpperCase()}
            </span>
          </td>
          <td class="px-4 py-3 align-top text-brand-text-mid">
            ${shortId(p.id)}
          </td>
          <td class="px-4 py-3 align-top text-right">
            <div class="inline-flex flex-wrap gap-1 justify-end">
              ${
                role === "pending"
                  ? `<button
                      class="px-2 py-1 rounded-md bg-brand-accent-light text-brand-dark-bg text-[0.7rem] font-semibold"
                      data-action="approve-student"
                      data-id="${p.id}"
                    >
                      Approve
                    </button>`
                  : ""
              }
              ${
                role !== "admin"
                  ? `<button
                      class="px-2 py-1 rounded-md bg-card-bg border border-brand-accent-dark/60 text-[0.7rem] text-brand-text-mid hover:border-brand-accent-light"
                      data-action="make-admin"
                      data-id="${p.id}"
                    >
                      Make admin
                    </button>`
                  : `<button
                      class="px-2 py-1 rounded-md bg-card-bg border border-brand-accent-dark/60 text-[0.7rem] text-brand-text-mid hover:border-brand-accent-light"
                      data-action="make-student"
                      data-id="${p.id}"
                    >
                      Make student
                    </button>`
              }
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function applyUserSearchAndSort() {
      const term = $("user-search").value.toLowerCase().trim();
      if (!term) {
        filteredProfiles = [...allProfiles];
      } else {
        filteredProfiles = allProfiles.filter((p) => {
          const combo = [
            p.full_name,
            p.username,
            p.email,
            p.role,
            p.id,
          ]
            .filter(Boolean)
            .join(" ")
            .toLowerCase();
          return combo.includes(term);
        });
      }
      renderUsersTable();
    }

    function sortUsers(mode) {
      filteredProfiles.sort((a, b) => {
        const nameA = (a.full_name || a.username || "").toLowerCase();
        const nameB = (b.full_name || b.username || "").toLowerCase();
        if (mode === "name-asc") return nameA.localeCompare(nameB);
        if (mode === "name-desc") return nameB.localeCompare(nameA);
        if (mode === "role") {
          const rA = (a.role || "student").toLowerCase();
          const rB = (b.role || "student").toLowerCase();
          return rA.localeCompare(rB);
        }
        return 0;
      });
      renderUsersTable();
    }

    async function updateUserRole(id, role) {
      hideGlobalError();
      const { error } = await supabaseClient
        .from("profiles")
        .update({ role })
        .eq("id", id);

      if (error) {
        console.error(error);
        showGlobalError("Failed to update role. Check RLS on profiles table.");
        return;
      }
      await loadProfiles();
    }

    // 3) NEWSLETTERS
    async function initNewsletterEditor() {
      quill = new Quill("#newsletter-editor", {
        theme: "snow",
        placeholder: "Write your newsletter here‚Ä¶",
        modules: {
          toolbar: [
            [{ header: [1, 2, 3, false] }],
            ["bold", "italic", "underline"],
            [{ list: "ordered" }, { list: "bullet" }],
            ["link"],
            ["clean"],
          ],
        },
      });

      quill.on("text-change", updateNewsletterPreview);
      $("newsletter-title").addEventListener("input", updateNewsletterPreview);
    }

    function updateNewsletterPreview() {
      const title = $("newsletter-title").value.trim();
      const html = quill.root.innerHTML.trim();
      $("newsletter-preview-title").textContent = title || "(Title will appear here)";
      $("newsletter-preview-body").innerHTML = html || "Start typing in the editor to see a preview...";
    }

    async function loadNewsletters() {
      hideGlobalError();
      const listEl = $("newsletter-list");
      listEl.innerHTML = `<p class="text-brand-text-mid text-sm">Loading newsletters‚Ä¶</p>`;

      const { data, error } = await supabaseClient
        .from("newsletters")
        .select("*")
        .order("created_at", { ascending: false });

      if (error) {
        console.error(error);
        listEl.innerHTML = `
          <p class="text-error-red text-sm">
            Could not load newsletters. Ensure the <code>newsletters</code> table exists with:
            id (uuid), title (text), content_html (text), created_at (timestamp), published (boolean).
          </p>
        `;
        return;
      }

      $("stat-newsletters").textContent = data.length.toString();

      if (!data.length) {
        listEl.innerHTML = `
          <p class="text-brand-text-mid text-sm">
            No newsletters yet. Write one on the left and click ‚ÄúSave Draft‚Äù or ‚ÄúPublish‚Äù.
          </p>
        `;
        return;
      }

      listEl.innerHTML = "";
      data.forEach((n) => {
        const item = document.createElement("button");
        item.type = "button";
        item.className =
          "newsletter-item w-full text-left px-3 py-2 rounded-lg bg-brand-dark-bg/70 border border-brand-accent-dark/50 hover:border-brand-accent-light transition";
        item.dataset.id = n.id;

        const statusBadge = n.published
          ? `<span class="pill-badge bg-brand-accent-light/15 text-brand-accent-light border border-brand-accent-light/40 ml-2">PUBLISHED</span>`
          : `<span class="pill-badge bg-yellow-500/10 text-yellow-300 border border-yellow-500/40 ml-2">DRAFT</span>`;

        item.innerHTML = `
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="font-semibold text-brand-text-light flex items-center">
                ${n.title || "(Untitled)"} ${statusBadge}
              </div>
              <div class="text-[0.7rem] text-brand-text-mid mt-0.5">
                ${formatDate(n.created_at)}
              </div>
            </div>
            <div class="flex flex-col items-end gap-1 text-[0.7rem]">
              <button
                class="px-2 py-1 rounded-md bg-card-bg border border-brand-accent-dark/60 text-brand-text-mid hover:border-brand-accent-light"
                data-action="toggle-publish"
                data-id="${n.id}"
              >
                ${n.published ? "Unpublish" : "Publish"}
              </button>
              <button
                class="px-2 py-1 rounded-md bg-card-bg border border-error-red/60 text-error-red hover:bg-red-900/40"
                data-action="delete-newsletter"
                data-id="${n.id}"
              >
                Delete
              </button>
            </div>
          </div>
        `;
        listEl.appendChild(item);
      });
    }

    async function saveNewsletter(published) {
  hideGlobalError();

  const title = $("newsletter-title").value.trim();
  const html = quill.root.innerHTML.trim();

  if (!title && !html) {
    showGlobalError("Cannot save an empty newsletter.");
    return;
  }

  const payload = {
    title: title || "(Untitled)",
    content_html: html || "",
    published: !!published,
    updated_at: new Date().toISOString()
  };

  if (currentNewsletterId) {
    payload.id = currentNewsletterId;
  }

  const { data, error } = await supabaseClient
    .from("newsletters")
    .upsert(payload)
    .select()
    .single();

  if (error) {
    console.error(error);
    showGlobalError("Failed to save newsletter. Check RLS.");
    return;
  }

  currentNewsletterId = data.id;
  await loadNewsletters();
}

      // If published true ‚Üí call Edge Function for email notifications (Mixed setup)
      if (published) {
        try {
          await supabaseClient.functions.invoke("newsletter-notify", {
            body: {
              newsletter_id: data.id,
              title: data.title,
              content_html: data.content_html,
            },
          });
        } catch (fnErr) {
          console.warn("newsletter-notify function failed or not deployed yet:", fnErr);
          // We don't block the UI; newsletter is still saved & published.
        }
      }

      await loadNewsletters();
    }

    function clearNewsletterEditor() {
      currentNewsletterId = null;
      $("newsletter-title").value = "";
      if (quill) quill.setContents([]);
      updateNewsletterPreview();
    }

    async function toggleNewsletterPublish(id) {
      hideGlobalError();
      const { data, error } = await supabaseClient
        .from("newsletters")
        .select("id, published, title, content_html")
        .eq("id", id)
        .single();

      if (error || !data) {
        showGlobalError("Could not toggle publish state ‚Äî row not found.");
        return;
      }

      const newState = !data.published;

      const { error: updateError } = await supabaseClient
        .from("newsletters")
        .update({ published: newState })
        .eq("id", id);

      if (updateError) {
        console.error(updateError);
        showGlobalError("Failed to update publish state.");
        return;
      }

      if (newState) {
        // Just published ‚Üí notify via Edge function
        try {
          await supabaseClient.functions.invoke("newsletter-notify", {
            body: {
              newsletter_id: data.id,
              title: data.title,
              content_html: data.content_html,
            },
          });
        } catch (err) {
          console.warn("newsletter-notify function failed or not deployed yet:", err);
        }
      }

      await loadNewsletters();
    }

    async function deleteNewsletter(id) {
      hideGlobalError();
      if (!confirm("Delete this newsletter permanently?")) return;

      const { error } = await supabaseClient
        .from("newsletters")
        .delete()
        .eq("id", id);

      if (error) {
        console.error(error);
        showGlobalError("Failed to delete newsletter.");
        return;
      }

      if (currentNewsletterId === id) {
        clearNewsletterEditor();
      }

      await loadNewsletters();
    }

    function handleNewsletterListClick(event) {
      const target = event.target;
      const item = target.closest(".newsletter-item");
      if (!item) return;

      const id = item.dataset.id;
      const actionBtn = target.closest("button[data-action]");
      if (actionBtn) {
        const action = actionBtn.dataset.action;
        const nId = actionBtn.dataset.id;
        if (action === "toggle-publish") {
          toggleNewsletterPublish(nId);
        } else if (action === "delete-newsletter") {
          deleteNewsletter(nId);
        }
        return;
      }

      loadNewsletterIntoEditor(id);
    }

    async function loadNewsletterIntoEditor(id) {
      hideGlobalError();
      const { data, error } = await supabaseClient
        .from("newsletters")
        .select("*")
        .eq("id", id)
        .single();

      if (error || !data) {
        console.error(error);
        showGlobalError("Could not load that newsletter.");
        return;
      }

      currentNewsletterId = data.id;
      $("newsletter-title").value = data.title || "";
      quill.root.innerHTML = data.content_html || "";
      updateNewsletterPreview();
    }

    // 4) FILES (Storage: student_files)
    function populateStudentSelect() {
      const select = $("files-student-select");
      if (!select) return;

      const previous = select.value;
      select.innerHTML = `<option value="">Select a student...</option>`;

      const students = allProfiles.filter((p) => p.role !== "admin");

      students.forEach((p) => {
        const opt = document.createElement("option");
        opt.value = p.id;
        const name = p.full_name || p.username || "(no name)";
        opt.textContent = `${name} ‚Äî ${shortId(p.id)}`;
        select.appendChild(opt);
      });

      if (students.some((p) => p.id === previous)) {
        select.value = previous;
      }
    }

    async function loadFilesForStudent(studentId) {
      const listEl = $("file-list");
      if (!studentId) {
        listEl.innerHTML =
          '<p class="text-brand-text-mid text-sm">Select a student above to view their attached files.</p>';
        return;
      }

      listEl.innerHTML =
        '<p class="text-brand-text-mid text-sm">Loading files from storage‚Ä¶</p>';

      try {
        const { data, error } = await supabaseClient.storage
          .from("student_files")
          .list(studentId + "/", {
            limit: 100,
            offset: 0,
            sortBy: { column: "name", order: "asc" },
          });

        if (error) {
          console.error(error);
          listEl.innerHTML =
            '<p class="text-error-red text-sm">Could not list files. Ensure the <code>student_files</code> bucket exists and storage policies allow admin access.</p>';
          return;
        }

        if (!data || !data.length) {
          listEl.innerHTML =
            '<p class="text-brand-text-mid text-sm">No files uploaded yet for this student.</p>';
          return;
        }

        listEl.innerHTML = "";
        data.forEach((file) => {
          const fullPath = `${studentId}/${file.name}`;
          const { data: pub } = supabaseClient.storage
            .from("student_files")
            .getPublicUrl(fullPath);
          const url = pub?.publicUrl || "#";

          const row = document.createElement("div");
          row.className =
            "flex items-center justify-between gap-3 px-3 py-2 rounded-lg bg-brand-dark-bg/70 border border-brand-accent-dark/60";
          row.innerHTML = `
            <div class="text-[0.8rem] sm:text-xs">
              <div class="font-semibold text-brand-text-light break-all">${file.name}</div>
            </div>
            <div class="flex items-center gap-2 text-[0.7rem]">
              <a
                href="${url}"
                target="_blank"
                class="px-2 py-1 rounded-md bg-card-bg border border-brand-accent-dark/60 text-brand-text-mid hover:border-brand-accent-light"
              >
                View / Download
              </a>
              <button
                class="px-2 py-1 rounded-md bg-card-bg border border-error-red/60 text-error-red hover:bg-red-900/40"
                data-file="${file.name}"
                data-student="${studentId}"
              >
                Delete
              </button>
            </div>
          `;
          listEl.appendChild(row);
        });
      } catch (err) {
        console.error(err);
        listEl.innerHTML =
          '<p class="text-error-red text-sm">Unexpected error while loading files.</p>';
      }
    }

    async function uploadFileForStudent() {
      hideGlobalError();
      const studentId = $("files-student-select").value;
      const input = $("file-input");
      const file = input.files[0];

      if (!studentId) {
        showGlobalError("Please choose a student before uploading.");
        return;
      }
      if (!file) {
        showGlobalError("Please select a file to upload.");
        return;
      }

      const path = `${studentId}/${Date.now()}-${file.name}`;

      const { error } = await supabaseClient.storage
        .from("student_files")
        .upload(path, file);

      if (error) {
        console.error(error);
        showGlobalError("File upload failed. Check storage policies and bucket name.");
        return;
      }

      input.value = "";
      await loadFilesForStudent(studentId);
    }

    async function deleteFile(studentId, fileName) {
      hideGlobalError();
      if (!confirm("Delete this file for this student?")) return;
      const fullPath = `${studentId}/${fileName}`;
      const { error } = await supabaseClient.storage
        .from("student_files")
        .remove([fullPath]);

      if (error) {
        console.error(error);
        showGlobalError("Failed to delete file from storage.");
        return;
      }
      await loadFilesForStudent(studentId);
    }

    // 5) TABS
    function switchTab(tabName) {
      const sections = {
        users: $("tab-users"),
        newsletters: $("tab-newsletters"),
        files: $("tab-files"),
      };

      Object.entries(sections).forEach(([key, el]) => {
        if (!el) return;
        if (key === tabName) {
          el.classList.remove("hidden");
        } else {
          el.classList.add("hidden");
        }
      });

      document.querySelectorAll(".tab-btn").forEach((btn) => {
        const name = btn.getAttribute("data-tab");
        if (name === tabName) {
          btn.classList.remove("tab-inactive");
          btn.classList.add("tab-active");
        } else {
          btn.classList.remove("tab-active");
          btn.classList.add("tab-inactive");
        }
      });
    }

    // 6) INIT
    document.addEventListener("DOMContentLoaded", async () => {
      // Logout
      $("logout-button").addEventListener("click", async () => {
        await supabaseClient.auth.signOut();
        window.location.href = "login.html";
      });

      // Enforce admin + load base data
      await ensureAdmin();
      if (!currentAdminUser || !currentAdminProfile || currentAdminProfile.role !== "admin") {
        return;
      }

      // Tabs
      document.querySelectorAll(".tab-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const tab = btn.getAttribute("data-tab");
          switchTab(tab);
        });
      });

      // Users: search + sort + role actions
      $("user-search").addEventListener("input", applyUserSearchAndSort);
      document.querySelectorAll(".user-sort").forEach((btn) => {
        btn.addEventListener("click", () => {
          const mode = btn.getAttribute("data-sort");
          sortUsers(mode);
        });
      });
      $("users-table-body").addEventListener("click", (event) => {
        const btn = event.target.closest("button[data-action]");
        if (!btn) return;
        const action = btn.dataset.action;
        const id = btn.dataset.id;
        if (!id) return;

        if (action === "approve-student") {
          updateUserRole(id, "student");
        } else if (action === "make-admin") {
          updateUserRole(id, "admin");
        } else if (action === "make-student") {
          updateUserRole(id, "student");
        }
      });

      await loadProfiles();

      // Newsletters
      await initNewsletterEditor();
      await loadNewsletters();
      $("newsletter-save-draft").addEventListener("click", () => saveNewsletter(false));
      $("newsletter-publish").addEventListener("click", () => saveNewsletter(true));
      $("newsletter-clear").addEventListener("click", clearNewsletterEditor);
      $("newsletter-refresh").addEventListener("click", loadNewsletters);
      $("newsletter-list").addEventListener("click", handleNewsletterListClick);

      // Files
      $("files-student-select").addEventListener("change", (e) => {
        loadFilesForStudent(e.target.value);
      });
      $("upload-file-button").addEventListener("click", uploadFileForStudent);
      $("file-list").addEventListener("click", (event) => {
        const btn = event.target.closest("button[data-file][data-student]");
        if (!btn) return;
        deleteFile(btn.dataset.student, btn.dataset.file);
      });

      // Default tab
      switchTab("users");
    });
  </script>
</body>
</html>
